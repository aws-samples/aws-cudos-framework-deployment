Metadata: 
  AWS::CloudFormation::Interface: 
    ParameterGroups: 
      - 
        Label: 
          default: "Information:"
        Parameters: 
          - Readme1st
      - 
        Label: 
          default: "Required Parameters:"
        Parameters: 
          - KpiQuickSightUser
          - KpiQuicksightIdentityRegion
          - BucketFolderPath
          - AthenaQueryResultsBucket
          - CURDatabaseName
          - CURAthenaWorkgroup
          - CURTableName
      - 
        Label: 
          default: "Optional Parameters:"
        Parameters: 
          - KpiQuickSightDataSetRefreshSchedule
          - Suffix
    ParameterLabels: 
      Readme1st: 
        default: "Please review the documentation before proceeding:"
      AthenaQueryResultsBucket:
        default: "Name of the S3 bucket configured for athena query results (do not add a trailing slash):"
      CURDatabaseName:
        default: "Athena Database Name:"
      CURAthenaWorkgroup:
        default: "Athena Workgroup:"
      CURTableName:
        default: "Cost & Usage Report Table Name:"
      BucketFolderPath:
        default: "S3 Bucket Path to the Cost & Usage Reports:"
      KpiQuickSightDataSetRefreshSchedule:
        default: "Preferred Refresh Schedule (remove to skip refreshing):"
      KpiQuickSightUser:
        default: "QuickSight Username (as displayed in QuickSight admin panel):"
      KpiQuicksightIdentityRegion:
        default: "Quicksight Identity Region (can be different than the region you deploy the dashboard, typically us-east-1):"
      Suffix:
        default: "Suffix value to use if you need to create multiple instances on the same AWS Account:"
# -----
Parameters:
  Readme1st:
    Type: String
    Default: https://www.wellarchitectedlabs.com/cost/200_labs/200_cloud_intelligence/cost-usage-report-dashboards/dashboards/2c_kpi_dashboard
  KpiQuickSightUser:
    Type: String
    MinLength: 1
  KpiQuicksightIdentityRegion:
    Type: String
    MinLength: 8
    Default: es-east-1
  BucketFolderPath:
    Type: String
    MinLength: 3
  AthenaQueryResultsBucket:
    Type: String
    MinLength: 3
  CURDatabaseName:
    Type:  String
    MinLength: 1
  CURAthenaWorkgroup:
    Type:  String
    MinLength: 1
    Default: primary
  CURTableName:
    Type:  String
    MinLength: 1
  KpiQuickSightDataSetRefreshSchedule:
    Type: String
    MinLength: 3
    Default: cron(0 4 * * ? *)
  Suffix:
    Type: String
# -----
Mappings:
  Definitions:
    kpiSourceAccountId:
      Value: "223485597511"
    kpiSourceTemplateId:
      Value: "kpi_dashboard"
    kpiViewsMetadataPath:
      Value: "https://raw.githubusercontent.com/aws-samples/aws-cudos-framework-deployment/main/cfn-templates/views_kpi.json"
    sharedAccountMapView:
      Value: "account_map"
    sharedSummaryView:
      Value: "summary_view"
    sharedRiSpMappingView:
      Value: "ri_sp_mapping"
    kpiInstanceMappingView:
      Value: "kpi_instance_mapping"
    kpiEbsSnapView:
      Value: "kpi_ebs_snap"
    kpiEbsStorageAllView:
      Value: "kpi_ebs_storage_all"
    kpiInstanceAllView:
      Value: "kpi_instance_all"
    kpiS3StorageAllView:
      Value: "kpi_s3_storage_all"
    kpiTrackerView:
      Value: "kpi_tracker"
    kpiDataSourceId:
      Value: "kpi-dashboard"
    kpiDashboardId:
      Value: "kpi-dashboard"
# -----
Conditions:
  CreateSPICERefresh: !Not [!Equals [!Ref KpiQuickSightDataSetRefreshSchedule, ""]]
# -----
Resources:
# -----
  KPICustomResourceViewsLambdaExecRole: 
    Type: AWS::IAM::Role
    Properties:
      Path: /
      RoleName: !Join
        - ''
        - - CustomResourceViewsLambdaExecRole
          - !Ref Suffix
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: !Join
          - ''
          - - CustomResourceViewsLambdaRolePolicy
            - !Ref Suffix
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - athena:StartQueryExecution
                  - athena:GetWorkGroup
                  - athena:GetQueryResults
                  - athena:GetQueryExecution
                Resource: !Join
                  - ''
                  - - 'arn:aws:athena:'
                    - !Ref AWS::Region
                    - ':'
                    - !Ref AWS::AccountId
                    - ':workgroup/'
                    - !Ref CURAthenaWorkgroup
              - Effect: Allow
                Action:
                  - events:PutRule
                  - events:PutTargets
                  - events:RemoveTargets
                  - events:DeleteRule
                Resource: '*'
              - Effect: Allow
                Action:
                  - lambda:AddPermission
                  - lambda:RemovePermission
                Resource: !Join
                  - ''
                  - - 'arn:aws:lambda:'
                    - !Ref AWS::Region
                    - ':'
                    - !Ref AWS::AccountId
                    - ':function:'
                    - KPICustomResourceViewsLambdaHandler
                    - !Ref Suffix
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:GetObject
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:s3:::'
                      - !Select [0, !Split [ "/" , !Ref BucketFolderPath ]]
                  - !Join
                    - ''
                    - - 'arn:aws:s3:::'
                      - !Ref BucketFolderPath
                      - '/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:ListBucketMultipartUploads
                  - s3:ListMultipartUploadParts
                  - s3:AbortMultipartUpload
                  - s3:GetBucketLocation
                  - s3:GetObject
                  - s3:PutObject
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:s3:::'
                      - !Ref AthenaQueryResultsBucket
                  - !Join
                    - ''
                    - - 'arn:aws:s3:::'
                      - !Ref AthenaQueryResultsBucket
                      - '/*'
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                  - kms:Encrypt
                Resource: !Join
                  - ''
                  - - 'arn:aws:kms:'
                    - !Ref AWS::Region
                    - ':'
                    - !Ref AWS::AccountId
                    - ':key/*'
              - Effect: Allow
                Action:
                  - glue:GetDatabase
                  - glue:GetDatabases
                  - glue:GetTable
                  - glue:UpdateTable
                  - glue:GetTables
                  - glue:GetPartitions
                  - glue:CreateTable
                  - glue:DeleteTable
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:glue:'
                      - !Ref AWS::Region
                      - ':'
                      - !Ref AWS::AccountId
                      - ':database/'
                      - !Ref CURDatabaseName
                  - !Join
                    - ''
                    - - 'arn:aws:glue:'
                      - !Ref AWS::Region
                      - ':'
                      - !Ref AWS::AccountId
                      - ':table/'
                      - !Ref CURDatabaseName
                      - '/*'
                  - !Join
                    - ''
                    - - 'arn:aws:glue:'
                      - !Ref AWS::Region
                      - ':'
                      - !Ref AWS::AccountId
                      - ':catalog'
# -----
  KPICustomResourceViewsLambdaHandler:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.7
      FunctionName: !Join
        - ''
        - - KPICustomResourceViewsLambdaHandler
          - !Ref Suffix
      Handler: index.handler
      MemorySize: 128
      Role: !GetAtt KPICustomResourceViewsLambdaExecRole.Arn
      Timeout: 60
      Environment:
        Variables:
          DatabaseName: !Ref CURDatabaseName
          TableName: !Ref CURTableName
          AthenaWorkgroup: !Ref CURAthenaWorkgroup
          ViewMetadataUri:  !FindInMap [ "Definitions", "kpiViewsMetadataPath", "Value" ]
      Code:
        ZipFile: |
          import os
          import sys
          import boto3
          import botocore
          import logging
          import re
          import subprocess
          import urllib3
          import time
          import json

          # Function is called only a very limited number of times.
          subprocess.call('pip install crhelper==2.0.10 -t /tmp/ --no-cache-dir'.split(), stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
          sys.path.insert(1, '/tmp/')

          from crhelper import CfnResource
          from botocore.exceptions import ClientError

          logger = logging.getLogger(__name__)

          helper = CfnResource(json_logging=False, log_level='DEBUG', boto_level='CRITICAL', sleep_on_delete=120)

          try:
            # Clients
            athena_client = boto3.client('athena')
            glue_client = boto3.client('glue')
            http = urllib3.PoolManager()
            # Variables
            database_name = os.environ["DatabaseName"]
            table_name = os.environ["TableName"]
            athena_workgroup = os.environ["AthenaWorkgroup"]
            view_metadata_uri = os.environ["ViewMetadataUri"]
          except Exception as e:
            helper.init_failure(e)

          def handler(event, context):
            helper(event, context)

          @helper.create
          @helper.update
          def create_handler(event, context):
            logger.info("View creation started..")

            # Trying to read the view code from the resource. If that fails the code will be fetched instead.
            try:
              fetched_view_code = event['ResourceProperties']['ViewCode']
            except Exception as e:
              fetched_view_code = ""

            try:
              fetched_view_name = event['ResourceProperties']['ViewName']
              if fetched_view_code:
                logger.info("Source code provided inline. Skipping fetching step.")
                fetched_code = fetched_view_code
              else:
                logger.info("Source Code was not passed. Downloading from the repository..")
                fetched_file_type = define_file_type(table_name)
                fetched_source_filename = define_view_source_filename(fetched_view_name, fetched_file_type)
                fetched_code = get_view_code(table_name, fetched_source_filename)

              logger.info("Create or Replace View: " + fetched_view_name)

              response = athena_client.start_query_execution(
                QueryString=fetched_code,
                QueryExecutionContext={'Database': database_name},
                WorkGroup=athena_workgroup
              )
              logger.info(response)

              query_execution = athena_client.get_query_execution(QueryExecutionId=response['QueryExecutionId'])
              logger.info(query_execution)

              if query_execution['QueryExecution']['Status']['State'] == 'FAILED':
                logger.error("View: " + fetched_view_name + " statement failed.")
                raise ValueError("View: " + fetched_view_name + " statement failed.")

              helper.Data['success'] = True
              helper.Data['id'] = response['QueryExecutionId']
              helper.Data['message'] = 'View: ' + fetched_view_name + ' statement is running..'

            except Exception as e:
              raise ValueError(f"An exception occurred: {e}")

            if not helper.Data.get("success"):
              raise ValueError("Creating custom resource failed.")

            return True

          @helper.delete
          def delete_handler(event, context):
            #########################################################################################################
            #### Skipping the delete functionality as retaining of the views might be required!                  ####
            #### If you want to remove the views upon stack removal, please comment out the following two lines! ####
            #########################################################################################################
            logger.info("View deletion skipped. Review the cloudformation template for more information.")
            return True 
            # Actual removal functionality starts here.
            logger.info("View deletion started")
            try:
              database_name = os.environ["DatabaseName"]
              athena_workgroup = os.environ["AthenaWorkgroup"]
              fetched_view_name = event['ResourceProperties']['ViewName']
              logger.info("Dropping View: " + fetched_view_name)
              response = athena_client.start_query_execution(
                QueryString='DROP VIEW IF EXISTS ' + fetched_view_name,
                QueryExecutionContext={'Database': database_name},
                WorkGroup=athena_workgroup
              )
              logger.info(response)

            except Exception as e:
              raise ValueError(f"An exception occurred: {e}")

          @helper.poll_create
          def poll_create(event, context):
            logger.info("Pol creation")

            response = athena_client.get_query_execution(QueryExecutionId=event['CrHelperData']['id'])

            logger.info(f"Poll response: {response}")

            if response['QueryExecution']['Status']['State'] == 'FAILED':
              logger.error("Statement FAILED")
              raise ValueError("Statement failed")

            if response['QueryExecution']['Status']['State'] == 'SUCCEEDED':
              logger.error("Statement SUCCEEDED")
              return True

            if response['QueryExecution']['Status']['State'] == 'QUEUED':
              logger.error("Statement QUEUED")
              return False
              
            return False

          # Helper Functions

          def get_view_code(table_name, file_address):
            logger.info('Downloading view file:' + file_address)
            view_code = str(http.request('GET', file_address).data.decode('utf-8'))
            view_code_updated = view_code.replace('${cur_table_name}',table_name)
            return view_code_updated
          
          def define_file_type(table_name):
            response = glue_client.get_table(DatabaseName=database_name, Name=table_name)
            savings_plan_present = False
            reserved_instance_present = False
            for column in response['Table']['StorageDescriptor']['Columns']:
                if column['Name'] == 'savings_plan_savings_plan_a_r_n':
                    if distinct_count(column['Name'], table_name, database_name, athena_workgroup) > 0:
                        savings_plan_present = True
                if column['Name'] == 'reservation_reservation_a_r_n':
                    if distinct_count(column['Name'], table_name, database_name, athena_workgroup) > 0:
                        reserved_instance_present = True
            if savings_plan_present and reserved_instance_present:
                return 'spriFile'
            elif savings_plan_present:
                return 'spFile'
            elif reserved_instance_present:
                return 'riFile'
            else:
                return 'File'

          def define_view_source_filename(view_name,file_type):
            view_metadata_uri = os.environ["ViewMetadataUri"]
            view_dict = json.loads(str(http.request('GET', view_metadata_uri).data.decode('utf-8')))
            if file_type in view_dict["view_templates"][view_name]:
              # If different value exists for RI/SP specific cases
              return view_dict["view_templates"][view_name]["Path"] + '/' + view_dict["view_templates"][view_name][file_type]
            else:
              # If no different values exist for RI/SP specific cases, use the default value
              return view_dict["view_templates"][view_name]["Path"] + '/' + view_dict["view_templates"][view_name]["File"]
          
          def distinct_count(fieldName, table_name, database_name, work_group):
            queryState = 'QUEUED'
            queryId = athena_client.start_query_execution(
                QueryString=f"""
                    SELECT COUNT(distinct {fieldName}) 
                    FROM {database_name}.{table_name} 
                    WHERE {fieldName} <> ''
                """.strip(),
                QueryExecutionContext={'Database': database_name},
                WorkGroup=work_group
            )['QueryExecutionId']
            while queryState in ['QUEUED','RUNNING']:
              time.sleep(10)
              queryState = athena_client.get_query_execution(QueryExecutionId=queryId)['QueryExecution']['Status']['State']
            response = athena_client.get_query_results(QueryExecutionId=queryId)
            return int(response['ResultSet']['Rows'][1]['Data'][0]['VarCharValue'])
# -----
  sharedAccountMapViewCustom:
    Type: Custom::AthenaView
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt KPICustomResourceViewsLambdaHandler.Arn
      ViewName: !FindInMap [ "Definitions", "sharedAccountMapView", "Value" ]
      ViewCode: !Join 
        - ""
        - - "CREATE OR REPLACE VIEW account_map AS SELECT DISTINCT line_item_usage_account_id account_id, line_item_usage_account_id account_name FROM "
          - !Ref CURTableName
      TableName: !Ref CURTableName
# -----
  sharedSummaryViewCustom:
    Type: Custom::AthenaView
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt KPICustomResourceViewsLambdaHandler.Arn
      ViewName: !FindInMap [ "Definitions", "sharedSummaryView", "Value" ]
      TableName: !Ref CURTableName
# -----
  sharedRiSpMappingViewCustom:
    Type: Custom::AthenaView
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt KPICustomResourceViewsLambdaHandler.Arn
      ViewName: !FindInMap [ "Definitions", "sharedRiSpMappingView", "Value" ]
      TableName: !Ref CURTableName
# -----
  kpiInstanceMappingViewCustom:
    Type: Custom::AthenaView
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt KPICustomResourceViewsLambdaHandler.Arn
      ViewName: !FindInMap [ "Definitions", "kpiInstanceMappingView", "Value" ]
      TableName: !Ref CURTableName
# -----
  kpiInstanceAllViewCustom:
    DependsOn: 
    - kpiInstanceMappingViewCustom
    - sharedAccountMapViewCustom
    Type: Custom::AthenaView
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt KPICustomResourceViewsLambdaHandler.Arn
      ViewName: !FindInMap [ "Definitions", "kpiInstanceAllView", "Value" ]
      TableName: !Ref CURTableName
# -----
  kpiEbsSnapViewCustom:
    DependsOn: sharedAccountMapViewCustom
    Type: Custom::AthenaView
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt KPICustomResourceViewsLambdaHandler.Arn
      ViewName: !FindInMap [ "Definitions", "kpiEbsSnapView", "Value" ]
      TableName: !Ref CURTableName
# -----
  kpiEbsStorageAllViewCustom:
    DependsOn: sharedAccountMapViewCustom
    Type: Custom::AthenaView
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt KPICustomResourceViewsLambdaHandler.Arn
      ViewName: !FindInMap [ "Definitions", "kpiEbsStorageAllView", "Value" ]
      TableName: !Ref CURTableName
# -----
  kpiS3StorageAllViewCustom:
    DependsOn: sharedAccountMapViewCustom
    Type: Custom::AthenaView
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt KPICustomResourceViewsLambdaHandler.Arn
      ViewName: !FindInMap [ "Definitions", "kpiS3StorageAllView", "Value" ]
      TableName: !Ref CURTableName
# -----
  kpiTrackerViewCustom:
    DependsOn: 
    - sharedAccountMapViewCustom
    - kpiEbsSnapViewCustom
    - kpiS3StorageAllViewCustom
    - kpiInstanceAllViewCustom
    - kpiEbsStorageAllViewCustom
    - sharedSummaryViewCustom
    Type: Custom::AthenaView
    Version: '1.0'
    Properties:
      ServiceToken: !GetAtt KPICustomResourceViewsLambdaHandler.Arn
      ViewName: !FindInMap [ "Definitions", "kpiTrackerView", "Value" ]
      TableName: !Ref CURTableName
# -----
  kpiQuickSightDataSource:
    Type: AWS::QuickSight::DataSource
    DependsOn:
    - kpiInstanceMappingViewCustom
    - kpiEbsSnapViewCustom
    - kpiEbsStorageAllViewCustom
    - kpiS3StorageAllViewCustom
    Properties: 
      AwsAccountId: !Ref "AWS::AccountId"
      DataSourceId: !Join 
        - ''
        - - !FindInMap [ "Definitions", "kpiDataSourceId", "Value" ]
          - !Ref Suffix 
      Name: !Join 
        - ''
        - - !FindInMap [ "Definitions", "kpiDataSourceId", "Value" ]
          - !Ref Suffix
      Type: ATHENA
      DataSourceParameters:
        AthenaParameters:
          WorkGroup: !Ref CURAthenaWorkgroup
      SslProperties:
        DisableSsl: false
      Permissions:
      - Principal: !Sub
        - 'arn:aws:quicksight:${Region}:${AWS::AccountId}:user/default/${Username}'
        - Username: !Ref KpiQuickSightUser
          Region: !Ref KpiQuicksightIdentityRegion
        Actions:
        - quicksight:DescribeDataSource
        - quicksight:DescribeDataSourcePermissions
        - quicksight:PassDataSource
        - quicksight:UpdateDataSource
        - quicksight:DeleteDataSource
        - quicksight:UpdateDataSourcePermissions
# -----
  kpiEbsSnapQuickSightDataSet:
    Type: AWS::QuickSight::DataSet
    DependsOn: kpiEbsSnapViewCustom
    Properties:
      AwsAccountId: !Ref "AWS::AccountId"
      DataSetId: 0e7cd1a6-e38d-4ca8-af6f-9256577d651e
      Name: !Join [ '' , [ 'kpi_ebs_snap' ,  !Ref Suffix ] ]
      PhysicalTableMap:
        f224e706-8cd3-4c2f-b4e8-d8470368782f:
          RelationalTable:
            DataSourceArn: !GetAtt kpiQuickSightDataSource.Arn
            Schema: !Ref CURDatabaseName
            Name: kpi_ebs_snap
            InputColumns:
            - Name: billing_period
              Type: DATETIME
            - Name: start_date
              Type: DATETIME
            - Name: payer_account_id
              Type: STRING
            - Name: linked_account_id
              Type: STRING
            - Name: account_id
              Type: STRING
            - Name: account_name
              Type: STRING
            - Name: resource_id
              Type: STRING
            - Name: snapshot_type
              Type: STRING
            - Name: usage_quantity
              Type: DECIMAL
            - Name: ebs_snapshot_cost
              Type: DECIMAL
            - Name: public_cost
              Type: DECIMAL
            - Name: ebs_snapshots_under_1yr_cost
              Type: DECIMAL
            - Name: ebs_snapshots_over_1yr_cost
              Type: DECIMAL
      LogicalTableMap:
        f224e706-8cd3-4c2f-b4e8-d8470368782f:
          Alias: kpi_ebs_snap
          DataTransforms:
          - ProjectOperation:
              ProjectedColumns:
              - billing_period
              - start_date
              - payer_account_id
              - linked_account_id
              - account_id
              - account_name
              - resource_id
              - snapshot_type
              - usage_quantity
              - ebs_snapshot_cost
              - public_cost
              - ebs_snapshots_under_1yr_cost
              - ebs_snapshots_over_1yr_cost
          Source:
            PhysicalTableId: f224e706-8cd3-4c2f-b4e8-d8470368782f
      ImportMode: SPICE
      Permissions:
      - Principal: !Sub
        - 'arn:aws:quicksight:${Region}:${AWS::AccountId}:user/default/${Username}'
        - Username: !Ref KpiQuickSightUser
          Region: !Ref KpiQuicksightIdentityRegion
        Actions:
        - quicksight:UpdateDataSetPermissions
        - quicksight:DescribeDataSet
        - quicksight:DescribeDataSetPermissions
        - quicksight:PassDataSet
        - quicksight:DescribeIngestion
        - quicksight:ListIngestions
        - quicksight:UpdateDataSet
        - quicksight:DeleteDataSet
        - quicksight:CreateIngestion
        - quicksight:CancelIngestion
# -----
  kpiEbsStorageAllQuickSightDataSet:
    Type: AWS::QuickSight::DataSet
    DependsOn: kpiEbsStorageAllViewCustom
    Properties:
      AwsAccountId: !Ref "AWS::AccountId"
      DataSetId: 7cc2766d-3009-403e-996f-f54c7f332e0d
      Name: !Join [ '' , [ 'kpi_ebs_storage_all' ,  !Ref Suffix ] ]
      PhysicalTableMap:
        23c71fa5-4992-4c85-b267-07d05b4eb69b:
          RelationalTable:
            DataSourceArn: !GetAtt kpiQuickSightDataSource.Arn
            Schema: !Ref CURDatabaseName
            Name: kpi_ebs_storage_all
            InputColumns:
            - Name: billing_period
              Type: DATETIME
            - Name: payer_account_id
              Type: STRING
            - Name: linked_account_id
              Type: STRING
            - Name: account_id
              Type: STRING
            - Name: account_name
              Type: STRING
            - Name: resource_id
              Type: STRING
            - Name: volume_api_name
              Type: STRING
            - Name: usage_storage_gb_mo
              Type: DECIMAL
            - Name: usage_iops_mo
              Type: DECIMAL
            - Name: usage_throughput_gibps_mo
              Type: DECIMAL
            - Name: storage_summary
              Type: STRING
            - Name: gp2_usage_added_iops_mo
              Type: DECIMAL
            - Name: gp2_usage_added_throughput_gibps_mo
              Type: INTEGER
            - Name: ebs_all_cost
              Type: DECIMAL
            - Name: ebs_sc1_cost
              Type: DECIMAL
            - Name: ebs_st1_cost
              Type: DECIMAL
            - Name: ebs_standard_cost
              Type: DECIMAL
            - Name: ebs_io1_cost
              Type: DECIMAL
            - Name: ebs_io2_cost
              Type: DECIMAL
            - Name: ebs_gp2_cost
              Type: DECIMAL
            - Name: ebs_gp3_cost
              Type: DECIMAL
            - Name: ebs_gp3_potential_savings
              Type: DECIMAL
      LogicalTableMap:
        23c71fa5-4992-4c85-b267-07d05b4eb69b:
          Alias: kpi_ebs_storage_all
          DataTransforms:
          - ProjectOperation:
              ProjectedColumns:
              - billing_period
              - payer_account_id
              - linked_account_id
              - account_id
              - account_name
              - resource_id
              - volume_api_name
              - usage_storage_gb_mo
              - usage_iops_mo
              - usage_throughput_gibps_mo
              - storage_summary
              - gp2_usage_added_iops_mo
              - gp2_usage_added_throughput_gibps_mo
              - ebs_all_cost
              - ebs_sc1_cost
              - ebs_st1_cost
              - ebs_standard_cost
              - ebs_io1_cost
              - ebs_io2_cost
              - ebs_gp2_cost
              - ebs_gp3_cost
              - ebs_gp3_potential_savings
          Source:
            PhysicalTableId: 23c71fa5-4992-4c85-b267-07d05b4eb69b
      ImportMode: SPICE
      Permissions:
      - Principal: !Sub
        - 'arn:aws:quicksight:${Region}:${AWS::AccountId}:user/default/${Username}'
        - Username: !Ref KpiQuickSightUser
          Region: !Ref KpiQuicksightIdentityRegion
        Actions:
        - quicksight:UpdateDataSetPermissions
        - quicksight:DescribeDataSet
        - quicksight:DescribeDataSetPermissions
        - quicksight:PassDataSet
        - quicksight:DescribeIngestion
        - quicksight:ListIngestions
        - quicksight:UpdateDataSet
        - quicksight:DeleteDataSet
        - quicksight:CreateIngestion
        - quicksight:CancelIngestion
# -----
  kpiInstanceAllQuickSightDataSet:
    Type: AWS::QuickSight::DataSet
    DependsOn: kpiInstanceAllViewCustom
    Properties:
      AwsAccountId: !Ref "AWS::AccountId"
      DataSetId: 5349c977-5ad9-4cd3-923d-868f4184e708
      Name: !Join [ '' , [ 'kpi_instance_all' ,  !Ref Suffix ] ]
      PhysicalTableMap:
        958b7222-e3e2-41ab-8093-6ba24c5e88a1:
          RelationalTable:
            DataSourceArn: !GetAtt kpiQuickSightDataSource.Arn
            Schema: !Ref CURDatabaseName
            Name: kpi_instance_all
            InputColumns:
            - Name: year
              Type: STRING
            - Name: month
              Type: STRING
            - Name: billing_period
              Type: DATETIME
            - Name: usage_date
              Type: DATETIME
            - Name: payer_account_id
              Type: STRING
            - Name: linked_account_id
              Type: STRING
            - Name: resource_id
              Type: STRING
            - Name: charge_type
              Type: STRING
            - Name: purchase_option
              Type: STRING
            - Name: product_code
              Type: STRING
            - Name: commit_service_group
              Type: STRING
            - Name: savings_plan_offering_type
              Type: STRING
            - Name: region
              Type: STRING
            - Name: operation
              Type: STRING
            - Name: usage_type
              Type: STRING
            - Name: instance_type_family
              Type: STRING
            - Name: instance_type
              Type: STRING
            - Name: platform
              Type: STRING
            - Name: tenancy
              Type: STRING
            - Name: processor
              Type: STRING
            - Name: adjusted_processor
              Type: STRING
            - Name: database_engine
              Type: STRING
            - Name: deployment_option
              Type: STRING
            - Name: license_model
              Type: STRING
            - Name: cache_engine
              Type: STRING
            - Name: usage_quantity
              Type: DECIMAL
            - Name: amortized_cost
              Type: DECIMAL
            - Name: adjusted_amortized_cost
              Type: DECIMAL
            - Name: public_cost
              Type: DECIMAL
            - Name: latest_graviton
              Type: STRING
            - Name: latest_amd
              Type: STRING
            - Name: latest_intel
              Type: STRING
            - Name: generation
              Type: STRING
            - Name: instance_processor
              Type: STRING
            - Name: account_id
              Type: STRING
            - Name: account_name
              Type: STRING
            - Name: sagemaker_all_cost
              Type: DECIMAL
            - Name: sagemaker_usage_cost
              Type: DECIMAL
            - Name: sagemaker_ondemand_cost
              Type: DECIMAL
            - Name: sagemaker_commit_savings
              Type: DECIMAL
            - Name: sagemaker_commit_potential_savings
              Type: DECIMAL
            - Name: compute_all_cost
              Type: DECIMAL
            - Name: compute_usage_cost
              Type: DECIMAL
            - Name: compute_ondemand_cost
              Type: DECIMAL
            - Name: compute_commit_savings
              Type: DECIMAL
            - Name: compute_commit_potential_savings
              Type: DECIMAL
            - Name: ec2_all_cost
              Type: DECIMAL
            - Name: ec2_usage_cost
              Type: DECIMAL
            - Name: ec2_spot_cost
              Type: DECIMAL
            - Name: ec2_previous_generation_cost
              Type: DECIMAL
            - Name: ec2_graviton_eligible_cost
              Type: DECIMAL
            - Name: ec2_graviton_cost
              Type: DECIMAL
            - Name: ec2_amd_eligible_cost
              Type: DECIMAL
            - Name: ec2_amd_cost
              Type: DECIMAL
            - Name: ec2_spot_potential_savings
              Type: DECIMAL
            - Name: ec2_spot_savings
              Type: DECIMAL
            - Name: ec2_previous_generation_potential_savings
              Type: DECIMAL
            - Name: ec2_graviton_potential_savings
              Type: DECIMAL
            - Name: ec2_amd_potential_savings
              Type: DECIMAL
            - Name: rds_all_cost
              Type: DECIMAL
            - Name: rds_ondemand_cost
              Type: DECIMAL
            - Name: rds_graviton_eligible_cost
              Type: DECIMAL
            - Name: rds_graviton_cost
              Type: DECIMAL
            - Name: rds_graviton_potential_savings
              Type: DECIMAL
            - Name: rds_commit_savings
              Type: DECIMAL
            - Name: rds_commit_potential_savings
              Type: DECIMAL
            - Name: elasticache_all_cost
              Type: DECIMAL
            - Name: elasticache_usage_cost
              Type: DECIMAL
            - Name: elasticache_ondemand_cost
              Type: DECIMAL
            - Name: elasticache_commit_savings
              Type: DECIMAL
            - Name: elasticache_commit_potential_savings
              Type: DECIMAL
            - Name: elasticache_graviton_eligible_cost
              Type: DECIMAL
            - Name: elasticache_graviton_cost
              Type: DECIMAL
            - Name: elasticache_graviton_potential_savings
              Type: DECIMAL
            - Name: opensearch_all_cost
              Type: DECIMAL
            - Name: opensearch_usage_cost
              Type: DECIMAL
            - Name: opensearch_ondemand_cost
              Type: DECIMAL
            - Name: opensearch_commit_savings
              Type: DECIMAL
            - Name: opensearch_commit_potential_savings
              Type: DECIMAL
            - Name: opensearch_graviton_eligible_cost
              Type: DECIMAL
            - Name: opensearch_graviton_cost
              Type: DECIMAL
            - Name: opensearch_graviton_potential_savings
              Type: DECIMAL
            - Name: redshift_all_cost
              Type: DECIMAL
            - Name: redshift_usage_cost
              Type: DECIMAL
            - Name: redshift_ondemand_cost
              Type: DECIMAL
            - Name: redshift_commit_savings
              Type: DECIMAL
            - Name: redshift_commit_potential_savings
              Type: DECIMAL
            - Name: dynamodb_all_cost
              Type: DECIMAL
            - Name: dynamodb_committed_cost
              Type: DECIMAL
            - Name: dynamodb_usage_cost
              Type: DECIMAL
            - Name: dynamodb_ondemand_cost
              Type: DECIMAL
            - Name: dynamodb_commit_savings
              Type: DECIMAL
            - Name: dynamodb_commit_potential_savings
              Type: DECIMAL
            - Name: lambda_all_cost
              Type: DECIMAL
            - Name: lambda_usage_cost
              Type: DECIMAL
            - Name: lambda_graviton_eligible_cost
              Type: DECIMAL
            - Name: lambda_graviton_cost
              Type: DECIMAL
            - Name: lambda_graviton_potential_savings
              Type: DECIMAL
      LogicalTableMap:
        958b7222-e3e2-41ab-8093-6ba24c5e88a1:
          Alias: kpi_instance_all
          DataTransforms:
          - TagColumnOperation:
              ColumnName: region
              Tags:
              - ColumnGeographicRole: STATE
          - ProjectOperation:
              ProjectedColumns:
              - year
              - month
              - billing_period
              - usage_date
              - payer_account_id
              - linked_account_id
              - resource_id
              - charge_type
              - purchase_option
              - product_code
              - commit_service_group
              - savings_plan_offering_type
              - region
              - operation
              - usage_type
              - instance_type_family
              - instance_type
              - platform
              - tenancy
              - processor
              - adjusted_processor
              - database_engine
              - deployment_option
              - license_model
              - cache_engine
              - usage_quantity
              - amortized_cost
              - adjusted_amortized_cost
              - public_cost
              - latest_graviton
              - latest_amd
              - latest_intel
              - generation
              - instance_processor
              - account_id
              - account_name
              - sagemaker_all_cost
              - sagemaker_usage_cost
              - sagemaker_ondemand_cost
              - sagemaker_commit_savings
              - sagemaker_commit_potential_savings
              - compute_all_cost
              - compute_usage_cost
              - compute_ondemand_cost
              - compute_commit_savings
              - compute_commit_potential_savings
              - ec2_all_cost
              - ec2_usage_cost
              - ec2_spot_cost
              - ec2_previous_generation_cost
              - ec2_graviton_eligible_cost
              - ec2_graviton_cost
              - ec2_amd_eligible_cost
              - ec2_amd_cost
              - ec2_spot_potential_savings
              - ec2_spot_savings
              - ec2_previous_generation_potential_savings
              - ec2_graviton_potential_savings
              - ec2_amd_potential_savings
              - rds_all_cost
              - rds_ondemand_cost
              - rds_graviton_eligible_cost
              - rds_graviton_cost
              - rds_graviton_potential_savings
              - rds_commit_savings
              - rds_commit_potential_savings
              - elasticache_all_cost
              - elasticache_usage_cost
              - elasticache_ondemand_cost
              - elasticache_commit_savings
              - elasticache_commit_potential_savings
              - elasticache_graviton_eligible_cost
              - elasticache_graviton_cost
              - elasticache_graviton_potential_savings
              - opensearch_all_cost
              - opensearch_usage_cost
              - opensearch_ondemand_cost
              - opensearch_commit_savings
              - opensearch_commit_potential_savings
              - opensearch_graviton_eligible_cost
              - opensearch_graviton_cost
              - opensearch_graviton_potential_savings
              - redshift_all_cost
              - redshift_usage_cost
              - redshift_ondemand_cost
              - redshift_commit_savings
              - redshift_commit_potential_savings
              - dynamodb_all_cost
              - dynamodb_committed_cost
              - dynamodb_usage_cost
              - dynamodb_ondemand_cost
              - dynamodb_commit_savings
              - dynamodb_commit_potential_savings
              - lambda_all_cost
              - lambda_usage_cost
              - lambda_graviton_eligible_cost
              - lambda_graviton_cost
              - lambda_graviton_potential_savings
          Source:
            PhysicalTableId: 958b7222-e3e2-41ab-8093-6ba24c5e88a1
      ImportMode: SPICE
      Permissions:
      - Principal: !Sub
        - 'arn:aws:quicksight:${Region}:${AWS::AccountId}:user/default/${Username}'
        - Username: !Ref KpiQuickSightUser
          Region: !Ref KpiQuicksightIdentityRegion
        Actions:
        - quicksight:UpdateDataSetPermissions
        - quicksight:DescribeDataSet
        - quicksight:DescribeDataSetPermissions
        - quicksight:PassDataSet
        - quicksight:DescribeIngestion
        - quicksight:ListIngestions
        - quicksight:UpdateDataSet
        - quicksight:DeleteDataSet
        - quicksight:CreateIngestion
        - quicksight:CancelIngestion
# -----
  kpiS3StorageAllQuickSightDataSet:
    Type: AWS::QuickSight::DataSet
    DependsOn: kpiS3StorageAllViewCustom
    Properties:
      AwsAccountId: !Ref "AWS::AccountId"
      DataSetId: 07c385e2-a43c-401c-abf4-fd54baed26a2
      Name: !Join [ '' , [ 'kpi_s3_storage_all' ,  !Ref Suffix ] ]
      PhysicalTableMap:
        99dd8380-97f3-4a26-b32c-79446aafb95e:
          RelationalTable:
            DataSourceArn: !GetAtt kpiQuickSightDataSource.Arn
            Schema: !Ref CURDatabaseName
            Name: kpi_s3_storage_all
            InputColumns:
            - Name: billing_period
              Type: DATETIME
            - Name: usage_date
              Type: DATETIME
            - Name: payer_account_id
              Type: STRING
            - Name: linked_account_id
              Type: STRING
            - Name: account_id
              Type: STRING
            - Name: account_name
              Type: STRING
            - Name: resource_id
              Type: STRING
            - Name: bucket_name_keywords
              Type: STRING
            - Name: last_requests
              Type: DATETIME
            - Name: s3_standard_underutilized_optimization
              Type: STRING
            - Name: s3_replication_bucket_optimization
              Type: STRING
            - Name: s3_standard_only_bucket
              Type: STRING
            - Name: s3_archive_in_use
              Type: STRING
            - Name: s3_inventory_in_use
              Type: STRING
            - Name: s3_analytics_in_use
              Type: STRING
            - Name: s3_int_in_use
              Type: STRING
            - Name: s3_standard_storage_potential_savings
              Type: DECIMAL
            - Name: s3_all_cost
              Type: DECIMAL
            - Name: s3_all_storage_cost
              Type: DECIMAL
            - Name: s3_all_storage_usage_quantity
              Type: DECIMAL
            - Name: s3_standard_storage_cost
              Type: DECIMAL
            - Name: s3_standard_storage_usage_quantity
              Type: DECIMAL
            - Name: s3_intelligent-tiering_storage_cost
              Type: DECIMAL
            - Name: s3_intelligent-tiering_storage_usage_quantity
              Type: DECIMAL
            - Name: s3_standard-ia_storage_cost
              Type: DECIMAL
            - Name: s3_standard-ia_storage_usage_quantity
              Type: DECIMAL
            - Name: s3_onezone-ia_storage_cost
              Type: DECIMAL
            - Name: s3_onezone-ia_storage_usage_quantity
              Type: DECIMAL
            - Name: s3_reduced_redundancy_storage_cost
              Type: DECIMAL
            - Name: s3_reduced_redundancy_storage_usage_quantity
              Type: DECIMAL
            - Name: s3_glacier_instant_retrieval_storage_cost
              Type: DECIMAL
            - Name: s3_glacier_instant_retrieval_storage_usage_quantity
              Type: DECIMAL
            - Name: s3_glacier_flexible_retrieval_storage_cost
              Type: DECIMAL
            - Name: s3_glacier_flexible_retrieval_storage_usage_quantity
              Type: DECIMAL
            - Name: s3_glacier_deep_archive_storage_storage_cost
              Type: DECIMAL
            - Name: s3_glacier_deep_archive_storage_usage_quantity
              Type: DECIMAL
            - Name: s3_early_delete_cost
              Type: DECIMAL
            - Name: s3_transition_usage_quantity
              Type: DECIMAL
            - Name: s3_put_object_usage_quantity
              Type: DECIMAL
            - Name: s3_put_object_replication_usage_quantity
              Type: DECIMAL
            - Name: s3_get_object_usage_quantity
              Type: DECIMAL
            - Name: s3_copy_object_usage_quantity
              Type: DECIMAL
      LogicalTableMap:
        99dd8380-97f3-4a26-b32c-79446aafb95e:
          Alias: kpi_s3_storage_all
          DataTransforms:
          - ProjectOperation:
              ProjectedColumns:
              - billing_period
              - usage_date
              - payer_account_id
              - linked_account_id
              - account_id
              - account_name
              - resource_id
              - bucket_name_keywords
              - last_requests
              - s3_standard_underutilized_optimization
              - s3_replication_bucket_optimization
              - s3_standard_only_bucket
              - s3_archive_in_use
              - s3_inventory_in_use
              - s3_analytics_in_use
              - s3_int_in_use
              - s3_standard_storage_potential_savings
              - s3_all_cost
              - s3_all_storage_cost
              - s3_all_storage_usage_quantity
              - s3_standard_storage_cost
              - s3_standard_storage_usage_quantity
              - s3_intelligent-tiering_storage_cost
              - s3_intelligent-tiering_storage_usage_quantity
              - s3_standard-ia_storage_cost
              - s3_standard-ia_storage_usage_quantity
              - s3_onezone-ia_storage_cost
              - s3_onezone-ia_storage_usage_quantity
              - s3_reduced_redundancy_storage_cost
              - s3_reduced_redundancy_storage_usage_quantity
              - s3_glacier_instant_retrieval_storage_cost
              - s3_glacier_instant_retrieval_storage_usage_quantity
              - s3_glacier_flexible_retrieval_storage_cost
              - s3_glacier_flexible_retrieval_storage_usage_quantity
              - s3_glacier_deep_archive_storage_storage_cost
              - s3_glacier_deep_archive_storage_usage_quantity
              - s3_early_delete_cost
              - s3_transition_usage_quantity
              - s3_put_object_usage_quantity
              - s3_put_object_replication_usage_quantity
              - s3_get_object_usage_quantity
              - s3_copy_object_usage_quantity
          Source:
            PhysicalTableId: 99dd8380-97f3-4a26-b32c-79446aafb95e
      ImportMode: SPICE
      Permissions:
      - Principal: !Sub
        - 'arn:aws:quicksight:${Region}:${AWS::AccountId}:user/default/${Username}'
        - Username: !Ref KpiQuickSightUser
          Region: !Ref KpiQuicksightIdentityRegion
        Actions:
        - quicksight:UpdateDataSetPermissions
        - quicksight:DescribeDataSet
        - quicksight:DescribeDataSetPermissions
        - quicksight:PassDataSet
        - quicksight:DescribeIngestion
        - quicksight:ListIngestions
        - quicksight:UpdateDataSet
        - quicksight:DeleteDataSet
        - quicksight:CreateIngestion
        - quicksight:CancelIngestion
# -----
  kpiTrackerQuickSightDataSet:
    Type: AWS::QuickSight::DataSet
    DependsOn: kpiTrackerViewCustom
    Properties:
      AwsAccountId: !Ref "AWS::AccountId"
      DataSetId: 5cdb47e4-2ea1-400a-b345-add87bd12151
      Name: !Join [ '' , [ 'kpi_tracker' ,  !Ref Suffix ] ]
      PhysicalTableMap:
        ca597aad-1079-4c11-a5ac-7d9deb38132a:
          RelationalTable:
            DataSourceArn: !GetAtt kpiQuickSightDataSource.Arn
            Schema: !Ref CURDatabaseName
            Name: kpi_tracker
            InputColumns:
            - Name: billing_period
              Type: DATETIME
            - Name: payer_account_id
              Type: STRING
            - Name: linked_account_id
              Type: STRING
            - Name: account_id
              Type: STRING
            - Name: account_name
              Type: STRING
            - Name: spend_all_cost
              Type: DECIMAL
            - Name: ec2_all_cost
              Type: DECIMAL
            - Name: ec2_spot_cost
              Type: DECIMAL
            - Name: ec2_spot_potential_savings
              Type: DECIMAL
            - Name: ec2_previous_generation_cost
              Type: DECIMAL
            - Name: ec2_previous_generation_potential_savings
              Type: DECIMAL
            - Name: ec2_graviton_eligible_cost
              Type: DECIMAL
            - Name: ec2_graviton_cost
              Type: DECIMAL
            - Name: ec2_graviton_potential_savings
              Type: DECIMAL
            - Name: ec2_amd_eligible_cost
              Type: DECIMAL
            - Name: ec2_amd_cost
              Type: DECIMAL
            - Name: ec2_amd_potential_savings
              Type: DECIMAL
            - Name: rds_all_cost
              Type: DECIMAL
            - Name: rds_ondemand_cost
              Type: DECIMAL
            - Name: rds_graviton_cost
              Type: DECIMAL
            - Name: rds_graviton_eligible_cost
              Type: DECIMAL
            - Name: rds_graviton_potential_savings
              Type: DECIMAL
            - Name: rds_commit_potential_savings
              Type: DECIMAL
            - Name: rds_commit_savings
              Type: DECIMAL
            - Name: elasticache_all_cost
              Type: DECIMAL
            - Name: elasticache_ondemand_cost
              Type: DECIMAL
            - Name: elasticache_graviton_cost
              Type: DECIMAL
            - Name: elasticache_graviton_eligible_cost
              Type: DECIMAL
            - Name: elasticache_graviton_potential_savings
              Type: DECIMAL
            - Name: elasticache_commit_potential_savings
              Type: DECIMAL
            - Name: elasticache_commit_savings
              Type: DECIMAL
            - Name: ebs_all_cost
              Type: DECIMAL
            - Name: ebs_gp_all_cost
              Type: DECIMAL
            - Name: ebs_gp2_cost
              Type: DECIMAL
            - Name: ebs_gp3_cost
              Type: DECIMAL
            - Name: ebs_gp3_potential_savings
              Type: DECIMAL
            - Name: ebs_snapshots_under_1yr_cost
              Type: DECIMAL
            - Name: ebs_snapshots_over_1yr_cost
              Type: DECIMAL
            - Name: ebs_snapshot_cost
              Type: DECIMAL
            - Name: s3_all_storage_cost
              Type: DECIMAL
            - Name: s3_standard_storage_cost
              Type: DECIMAL
            - Name: s3_standard_storage_potential_savings
              Type: DECIMAL
            - Name: compute_all_cost
              Type: DECIMAL
            - Name: compute_ondemand_cost
              Type: DECIMAL
            - Name: compute_commit_potential_savings
              Type: DECIMAL
            - Name: compute_commit_savings
              Type: DECIMAL
            - Name: dynamodb_all_cost
              Type: DECIMAL
            - Name: dynamodb_committed_cost
              Type: DECIMAL
            - Name: dynamodb_ondemand_cost
              Type: DECIMAL
            - Name: dynamodb_commit_potential_savings
              Type: DECIMAL
            - Name: dynamodb_commit_savings
              Type: DECIMAL
            - Name: opensearch_all_cost
              Type: DECIMAL
            - Name: opensearch_ondemand_cost
              Type: DECIMAL
            - Name: opensearch_graviton_cost
              Type: DECIMAL
            - Name: opensearch_graviton_eligible_cost
              Type: DECIMAL
            - Name: opensearch_graviton_potential_savings
              Type: DECIMAL
            - Name: opensearch_commit_potential_savings
              Type: DECIMAL
            - Name: opensearch_commit_savings
              Type: DECIMAL
            - Name: redshift_all_cost
              Type: DECIMAL
            - Name: redshift_ondemand_cost
              Type: DECIMAL
            - Name: redshift_commit_potential_savings
              Type: DECIMAL
            - Name: redshift_commit_savings
              Type: DECIMAL
            - Name: sagemaker_all_cost
              Type: DECIMAL
            - Name: sagemaker_ondemand_cost
              Type: DECIMAL
            - Name: sagemaker_commit_potential_savings
              Type: DECIMAL
            - Name: sagemaker_commit_savings
              Type: DECIMAL
            - Name: lambda_all_cost
              Type: DECIMAL
            - Name: lambda_graviton_cost
              Type: DECIMAL
            - Name: lambda_graviton_eligible_cost
              Type: DECIMAL
            - Name: lambda_graviton_potential_savings
              Type: DECIMAL
      LogicalTableMap:
        ca597aad-1079-4c11-a5ac-7d9deb38132a:
          Alias: kpi_tracker
          DataTransforms:
          - ProjectOperation:
              ProjectedColumns:
              - billing_period
              - payer_account_id
              - linked_account_id
              - account_id
              - account_name
              - spend_all_cost
              - ec2_all_cost
              - ec2_spot_cost
              - ec2_spot_potential_savings
              - ec2_previous_generation_cost
              - ec2_previous_generation_potential_savings
              - ec2_graviton_eligible_cost
              - ec2_graviton_cost
              - ec2_graviton_potential_savings
              - ec2_amd_eligible_cost
              - ec2_amd_cost
              - ec2_amd_potential_savings
              - rds_all_cost
              - rds_ondemand_cost
              - rds_graviton_cost
              - rds_graviton_eligible_cost
              - rds_graviton_potential_savings
              - rds_commit_potential_savings
              - rds_commit_savings
              - elasticache_all_cost
              - elasticache_ondemand_cost
              - elasticache_graviton_cost
              - elasticache_graviton_eligible_cost
              - elasticache_graviton_potential_savings
              - elasticache_commit_potential_savings
              - elasticache_commit_savings
              - ebs_all_cost
              - ebs_gp_all_cost
              - ebs_gp2_cost
              - ebs_gp3_cost
              - ebs_gp3_potential_savings
              - ebs_snapshots_under_1yr_cost
              - ebs_snapshots_over_1yr_cost
              - ebs_snapshot_cost
              - s3_all_storage_cost
              - s3_standard_storage_cost
              - s3_standard_storage_potential_savings
              - compute_all_cost
              - compute_ondemand_cost
              - compute_commit_potential_savings
              - compute_commit_savings
              - dynamodb_all_cost
              - dynamodb_committed_cost
              - dynamodb_ondemand_cost
              - dynamodb_commit_potential_savings
              - dynamodb_commit_savings
              - opensearch_all_cost
              - opensearch_ondemand_cost
              - opensearch_graviton_cost
              - opensearch_graviton_eligible_cost
              - opensearch_graviton_potential_savings
              - opensearch_commit_potential_savings
              - opensearch_commit_savings
              - redshift_all_cost
              - redshift_ondemand_cost
              - redshift_commit_potential_savings
              - redshift_commit_savings
              - sagemaker_all_cost
              - sagemaker_ondemand_cost
              - sagemaker_commit_potential_savings
              - sagemaker_commit_savings
              - lambda_all_cost
              - lambda_graviton_cost
              - lambda_graviton_eligible_cost
              - lambda_graviton_potential_savings
          Source:
            PhysicalTableId: ca597aad-1079-4c11-a5ac-7d9deb38132a
      ImportMode: SPICE
      Permissions:
      - Principal: !Sub
        - 'arn:aws:quicksight:${Region}:${AWS::AccountId}:user/default/${Username}'
        - Username: !Ref KpiQuickSightUser
          Region: !Ref KpiQuicksightIdentityRegion
        Actions:
        - quicksight:UpdateDataSetPermissions
        - quicksight:DescribeDataSet
        - quicksight:DescribeDataSetPermissions
        - quicksight:PassDataSet
        - quicksight:DescribeIngestion
        - quicksight:ListIngestions
        - quicksight:UpdateDataSet
        - quicksight:DeleteDataSet
        - quicksight:CreateIngestion
        - quicksight:CancelIngestion
# -----
  sharedSummaryViewDataset:
    Type: AWS::QuickSight::DataSet
    DependsOn: 
    - sharedSummaryViewCustom
    - sharedRiSpMappingViewCustom
    Properties:
      DataSetId: !Join [ '' , [ 'SummaryView' ,  !Ref Suffix ] ]
      AwsAccountId: !Ref AWS::AccountId
      Name: !Join [ '' , [ 'summary_view' ,  !Ref Suffix ] ] 
      ImportMode: SPICE
      LogicalTableMap:
        2af1581c-abc8-4f82-9f4f-4cebb089cefa:
          Alias: account_map
          Source:
            PhysicalTableId: 743ef98d-d1be-4e0a-9d5b-302619c92361
        637cc109-06d6-4cd2-bc17-1e1adbb0c2bf:
          Alias: Intermediate Table 2
          DataTransforms:
          - ProjectOperation:
              ProjectedColumns:
                - year
                - month
                - billing_period
                - usage_date
                - payer_account_id
                - linked_account_id
                - invoice_id
                - charge_type
                - charge_category
                - purchase_option
                - ri_sp_arn
                - product_code
                - product_name
                - service
                - product_family
                - usage_type
                - operation
                - item_description
                - availability_zone
                - region
                - instance_type
                - instance_type_family
                - platform
                - tenancy
                - processor
                - processor_features
                - database_engine
                - product_group
                - product_from_location
                - product_to_location
                - current_generation
                - legal_entity
                - billing_entity
                - pricing_unit
                - resource_id_count
                - usage_quantity
                - unblended_cost
                - amortized_cost
                - ri_sp_trueup
                - ri_sp_upfront_fees
                - public_cost
                - billing_period_mapping
                - payer_account_id_mapping
                - ri_sp_arn_mapping
                - ri_sp_end_date
                - ri_sp_term
                - ri_sp_offering
                - ri_sp_payment
                - account_id
                - account_name
          - TagColumnOperation:
              ColumnName: region
              Tags:
              - ColumnGeographicRole: STATE
          Source:
            JoinInstruction:
              LeftOperand: 7d2bff67-7548-42dc-a208-ed708c659848
              OnClause: '{linked_account_id} = {account_id}'
              RightOperand: 2af1581c-abc8-4f82-9f4f-4cebb089cefa
              Type: LEFT
        7d2bff67-7548-42dc-a208-ed708c659848:
          Alias: Intermediate Table
          Source:
            JoinInstruction:
              LeftOperand: 8e1f2eec-bbcc-43aa-9f3a-22ab03811c7c
              OnClause: '{ri_sp_arn} = {ri_sp_arn_mapping} AND {payer_account_id} = {payer_account_id_mapping} AND {billing_period} = {billing_period_mapping}'
              RightOperand: 9da61e8f-0610-4d2e-9f92-7e59799f0b53
              Type: LEFT
        8e1f2eec-bbcc-43aa-9f3a-22ab03811c7c:
          Alias: summary_view
          Source:
            PhysicalTableId: b8a2c186-48b4-44a7-b0fd-d94bc161ebc7
        9da61e8f-0610-4d2e-9f92-7e59799f0b53:
          Alias: ri_sp_mapping
          Source:
            PhysicalTableId: 8d5f8ef0-3f67-43ed-b332-a9fd0d40269c
      PhysicalTableMap:
        743ef98d-d1be-4e0a-9d5b-302619c92361:
          RelationalTable:
            DataSourceArn: !GetAtt kpiQuickSightDataSource.Arn
            InputColumns:
              - Name: account_id
                Type: STRING
              - Name: account_name
                Type: STRING
            Name: account_map
            Schema: !Ref CURDatabaseName
            Catalog: AwsDataCatalog
        8d5f8ef0-3f67-43ed-b332-a9fd0d40269c:
          RelationalTable:
            DataSourceArn: !GetAtt kpiQuickSightDataSource.Arn
            InputColumns:
              - Name: ri_sp_offering
                Type: STRING
              - Name: payer_account_id_mapping
                Type: STRING
              - Name: ri_sp_payment
                Type: STRING
              - Name: billing_period_mapping
                Type: DATETIME
              - Name: ri_sp_arn_mapping
                Type: STRING
              - Name: ri_sp_term
                Type: STRING
              - Name: ri_sp_end_date
                Type: DATETIME
            Name: ri_sp_mapping
            Schema: !Ref CURDatabaseName
            Catalog: AwsDataCatalog
        b8a2c186-48b4-44a7-b0fd-d94bc161ebc7:
          RelationalTable:
            DataSourceArn: !GetAtt kpiQuickSightDataSource.Arn
            InputColumns:
              - Name: billing_period
                Type: DATETIME
              - Name: purchase_option
                Type: STRING
              - Name: product_to_location
                Type: STRING
              - Name: charge_type
                Type: STRING
              - Name: current_generation
                Type: STRING
              - Name: year
                Type: STRING
              - Name: payer_account_id
                Type: STRING
              - Name: product_from_location
                Type: STRING
              - Name: usage_date
                Type: DATETIME
              - Name: ri_sp_trueup
                Type: DECIMAL
              - Name: amortized_cost
                Type: DECIMAL
              - Name: product_code
                Type: STRING
              - Name: platform
                Type: STRING
              - Name: usage_type
                Type: STRING
              - Name: linked_account_id
                Type: STRING
              - Name: invoice_id
                Type: STRING
              - Name: ri_sp_arn
                Type: STRING
              - Name: legal_entity
                Type: STRING
              - Name: product_group
                Type: STRING
              - Name: ri_sp_upfront_fees
                Type: DECIMAL
              - Name: processor_features
                Type: STRING
              - Name: product_family
                Type: STRING
              - Name: availability_zone
                Type: STRING
              - Name: billing_entity
                Type: STRING
              - Name: tenancy
                Type: STRING
              - Name: database_engine
                Type: STRING
              - Name: product_name
                Type: STRING
              - Name: processor
                Type: STRING
              - Name: instance_type_family
                Type: STRING
              - Name: charge_category
                Type: STRING
              - Name: month
                Type: STRING
              - Name: resource_id_count
                Type: INTEGER
              - Name: public_cost
                Type: DECIMAL
              - Name: unblended_cost
                Type: DECIMAL
              - Name: service
                Type: STRING
              - Name: usage_quantity
                Type: DECIMAL
              - Name: item_description
                Type: STRING
              - Name: region
                Type: STRING
              - Name: operation
                Type: STRING
              - Name: instance_type
                Type: STRING
              - Name: pricing_unit
                Type: STRING
            Name: summary_view
            Schema: !Ref CURDatabaseName
            Catalog: AwsDataCatalog
      Permissions:
      - Principal: !Sub
        - 'arn:aws:quicksight:${Region}:${AWS::AccountId}:user/default/${Username}'
        - Username: !Ref KpiQuickSightUser
          Region: !Ref KpiQuicksightIdentityRegion
        Actions:
            - quicksight:UpdateDataSetPermissions
            - quicksight:DescribeDataSet
            - quicksight:DescribeDataSetPermissions
            - quicksight:PassDataSet
            - quicksight:DescribeIngestion
            - quicksight:ListIngestions
            - quicksight:UpdateDataSet
            - quicksight:DeleteDataSet
            - quicksight:CreateIngestion
            - quicksight:CancelIngestion
# -----
  kpiQuickSightDashboard:
    Type: AWS::QuickSight::Dashboard
    Properties:
      AwsAccountId: !Ref "AWS::AccountId"
      DashboardId: !Join 
        - ''
        - - !FindInMap [ "Definitions", "kpiDashboardId", "Value" ]
          - !Ref Suffix 
      Name: !Join [ '' , [ 'KPI Dashboard' ,  !Ref Suffix ] ]
      Permissions:
      - Principal: !Sub
        - 'arn:aws:quicksight:${Region}:${AWS::AccountId}:user/default/${Username}'
        - Username: !Ref KpiQuickSightUser
          Region: !Ref KpiQuicksightIdentityRegion
        Actions:
        - quicksight:DescribeDashboard
        - quicksight:ListDashboardVersions
        - quicksight:UpdateDashboardPermissions
        - quicksight:QueryDashboard
        - quicksight:UpdateDashboard
        - quicksight:DeleteDashboard
        - quicksight:DescribeDashboardPermissions
        - quicksight:UpdateDashboardPublishedVersion
      DashboardPublishOptions:
        AdHocFilteringOption:
          AvailabilityStatus: DISABLED
      SourceEntity:
        SourceTemplate:
          DataSetReferences:
            - DataSetArn: !GetAtt kpiEbsSnapQuickSightDataSet.Arn
              DataSetPlaceholder: kpi_ebs_snap
            - DataSetArn: !GetAtt kpiEbsStorageAllQuickSightDataSet.Arn
              DataSetPlaceholder: kpi_ebs_storage_all
            - DataSetArn: !GetAtt kpiInstanceAllQuickSightDataSet.Arn
              DataSetPlaceholder: kpi_instance_all
            - DataSetArn: !GetAtt kpiS3StorageAllQuickSightDataSet.Arn
              DataSetPlaceholder: kpi_s3_storage_all
            - DataSetArn: !GetAtt kpiTrackerQuickSightDataSet.Arn
              DataSetPlaceholder: kpi_tracker
            - DataSetArn: !GetAtt sharedSummaryViewDataset.Arn
              DataSetPlaceholder: summary_view
          Arn: !Join 
            - ''
            - - 'arn:aws:quicksight:us-east-1:'
              - !FindInMap [ "Definitions", "kpiSourceAccountId", "Value" ]
              - ':template/'
              - !FindInMap [ "Definitions", "kpiSourceTemplateId", "Value" ]
      VersionDescription: '1'
# -----
  kpiSpiceRefreshExecutionRole:
    Type: AWS::IAM::Role
    Condition: CreateSPICERefresh
    Properties:
      Path: /
      RoleName: !Join
        - ''
        - - kpiSpiceRefreshExecutionRole
          - !Ref Suffix
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: !Join
          - ''
          - - SpiceRefreshExecutionPolicy
            - !Ref Suffix
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - quicksight:CreateIngestion
                Resource:
                  - Fn::Join: [ "/", [!GetAtt kpiEbsSnapQuickSightDataSet.Arn , "ingestion", "*" ] ]
                  - Fn::Join: [ "/", [!GetAtt kpiEbsStorageAllQuickSightDataSet.Arn , "ingestion", "*" ] ]
                  - Fn::Join: [ "/", [!GetAtt kpiInstanceAllQuickSightDataSet.Arn , "ingestion", "*" ] ]
                  - Fn::Join: [ "/", [!GetAtt kpiS3StorageAllQuickSightDataSet.Arn , "ingestion", "*" ] ]
                  - Fn::Join: [ "/", [!GetAtt kpiTrackerQuickSightDataSet.Arn , "ingestion", "*" ] ]
                  - Fn::Join: [ "/", [!GetAtt sharedSummaryViewDataset.Arn , "ingestion", "*" ] ]
              - Effect: Allow
                Action:
                  - quicksight:ListDatasets
                Resource:
                  - !Sub arn:aws:quicksight:${AWS::Region}:${AWS::AccountId}:dataset/*
# ----
  kpiSpiceRefreshLambdaCreator:
    Type: AWS::Lambda::Function
    Condition: CreateSPICERefresh
    Properties:
      Runtime: python3.7
      FunctionName: !Join
        - ''
        - - kpiQuickSightRefreshDatasets
          - !Ref Suffix
      Handler: index.lambda_handler
      MemorySize: 128
      Role: !GetAtt kpiSpiceRefreshExecutionRole.Arn
      Timeout: 60
      Environment:
        Variables:
          suffix: !Ref Suffix
      Code:
        ZipFile: |
          import boto3
          from datetime import datetime
          import os
          
          DATASETS_TO_REFRESH = [
              "kpi_ebs_snap" + os.environ['suffix'],
              "kpi_ebs_storage_all" + os.environ['suffix'],
              "kpi_instance_all" + os.environ['suffix'],
              "kpi_s3_storage_all" + os.environ['suffix'],
              "kpi_tracker" + os.environ['suffix'],
              "summary_view" + os.environ['suffix']
          ]

          def get_account_id():
              sts = boto3.client('sts')
              account_id = sts.get_caller_identity()['Account']
              print('account_id = ', account_id)
              return account_id
          
          def refresh_datasets(account_id):
              quicksight = boto3.client('quicksight')
              datasets = quicksight.list_data_sets(AwsAccountId=account_id)
              for dataset in datasets['DataSetSummaries']:
                  name = dataset['Name']
                  if dataset['ImportMode'] == 'SPICE' and name in DATASETS_TO_REFRESH:               
                      ingestion_id = datetime.now().strftime("%d%m%y-%H%M%S-%f")
                      print("Refreshing dataset {0}".format(name))
                      res = quicksight.create_ingestion(
                          AwsAccountId=account_id,
                          DataSetId=dataset['DataSetId'],
                          IngestionId=ingestion_id
                        )
                      print(res)

          def lambda_handler(event, context):
              account_id = get_account_id()
              refresh_datasets(account_id)
# ----
  kpiSpiceRefreshRule:
    Type: AWS::Events::Rule
    Condition: CreateSPICERefresh
    Properties:
      ScheduleExpression: !Ref KpiQuickSightDataSetRefreshSchedule
      Targets:
        - Id: SpiceRefreshScheduler
          Arn: !GetAtt kpiSpiceRefreshLambdaCreator.Arn
# ----
  kpiInvokeLambdaPermission:
    Type: AWS::Lambda::Permission
    Condition: CreateSPICERefresh
    Properties:
      FunctionName: !GetAtt kpiSpiceRefreshLambdaCreator.Arn
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt kpiSpiceRefreshRule.Arn

  kpiLoggerRole: #Execution role for the custom resource kpiLoggerExecutor
    Type: AWS::IAM::Role
    Properties:
      Path: /
      RoleName: !Join ['', ["kpiLoggerRole", !Ref Suffix] ]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  kpiLoggerLambdaCreator:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.9
      FunctionName: !Join ['', ["kpiLogger", !Ref Suffix] ]
      Handler: index.lambda_handler
      MemorySize: 128
      Role: !GetAtt kpiLoggerRole.Arn
      Timeout: 15
      Environment:
        Variables:
          API_ENDPOINT: https://okakvoavfg.execute-api.eu-west-1.amazonaws.com/
      Code:
        ZipFile: |
          import os
          import json
          import uuid
          import urllib3

          import boto3
          import cfnresponse

          http = urllib3.PoolManager()
          endpoint = os.environ["API_ENDPOINT"]
          account_id = boto3.client("sts").get_caller_identity()["Account"]
          
          def request(action, dashboard_id):
              message = f"Succesfully logged  {action} for {dashboard_id}"
              via_key = {'Create':'created_via', 'Update':'updated_via', 'Delete': 'deleted_via'}.get(action)
              verb = {'Create':'PUT', 'Update':'PATCH', 'Delete': 'DELETE'}.get(action)
              payload = {'dashboard_id': dashboard_id, 'account_id': account_id, via_key: 'CFN'}
              try:
                  r = http.request(verb, endpoint, body=json.dumps(payload).encode('utf-8'),headers={'Content-Type': 'application/json'})
                  if r.status!=200:
                      message = f"This will not fail the deployment. There has been an issue logging action {action} for dashboard {dashboard_id} and account {account_id}, server did not respond with a 200 response,actual  status: {r.status}, response data {r.data.decode('utf-8')}. This issue will be ignored"
              except urllib3.exceptions.HTTPError as e:
                  message = f"Issue logging action {action} for dashboard {dashboard_id} and account {account_id}, due to a urllib3 exception {str(e)} . This issue will be ignored"
              return message
          
          def lambda_handler(event, context):
              if event['RequestType'] in ('Create', 'Update', 'Delete'):
                  dashboards = event['ResourceProperties']['dashboards']
                  action = event['RequestType']
                  #Do not stop deployment if we're not able to succesfully record this deployment, still return true
                  res, reason = True, '\n'.join([request(action, dashboard_id) for dashboard_id in dashboards])
              else:
                  res, reason = False,  f"Unknown operation: {event['RequestType']}"
              resp = {'Reason': reason}
              print(resp)
              cfnresponse.send(event, context, cfnresponse.SUCCESS if res else cfnresponse.FAILED, resp, event.get('PhysicalResourceId', None) or str(uuid.uuid1()))

  kpiLoggerLambdaExecutor:
    Type: Custom::kpiLoggerLambdaExecutor
    DependsOn: [ "kpiQuickSightDashboard" ]
    Properties:
      ServiceToken: !GetAtt kpiLoggerLambdaCreator.Arn
      Region: !Ref "AWS::Region"
      Name: !Join ['', ["kpiLoggerLambdaExecutor", !Ref Suffix] ]
      dashboards:
        - kpi
