dashboards:
  AWS MARKETPLACE SINGLE PANE OF GLASS (SPG):
    dependsOn:
      datasets:
      - marketplace_licenses_grants_view
      - marketplace_view
    name: AWS MARKETPLACE SINGLE PANE OF GLASS (SPG)
    dashboardId: aws-marketplace
    category: Custom
    theme: MIDNIGHT
    templateId: aws-marketplace
    sourceAccountId: '412381751852'
    region: us-east-1
datasets:
  marketplace_licenses_grants_view:
    data:
      DataSetId: ff35b25e-c8d1-4859-b388-ce4d6cbeb506
      Name: marketplace_licenses_grants_view
      PhysicalTableMap:
        1ecbb2ac-1ceb-4653-ab08-dc11fdfeb1b1:
          RelationalTable:
            DataSourceArn: ${athena_datasource_arn}
            Catalog: AwsDataCatalog
            Schema: ${athena_database_name}
            Name: account_map
            InputColumns:
            - Name: account_id
              Type: STRING
            - Name: account_name
              Type: STRING
        623cef5c-7541-4cb2-9474-53cb0e222d67:
          RelationalTable:
            DataSourceArn: ${athena_datasource_arn}
            Catalog: AwsDataCatalog
            Schema: ${athena_database_name}
            Name: marketplace_licenses_grants_view
            InputColumns:
            - Name: management_account_id
              Type: STRING
            - Name: subscribed_account_id
              Type: STRING
            - Name: grantee_account_id
              Type: STRING
            - Name: license_create_time
              Type: DATETIME
            - Name: license_start_date
              Type: DATETIME
            - Name: license_end_date
              Type: DATETIME
            - Name: license_id
              Type: STRING
            - Name: productname
              Type: STRING
            - Name: seller
              Type: STRING
            - Name: agreement_id
              Type: STRING
            - Name: license_status
              Type: STRING
            - Name: productsku
              Type: STRING
            - Name: license_issuer
              Type: STRING
            - Name: homeregion
              Type: STRING
            - Name: license_version
              Type: STRING
            - Name: grant_name
              Type: STRING
            - Name: grant_id
              Type: STRING
            - Name: grant_status
              Type: STRING
            - Name: grant_version
              Type: STRING
            - Name: granted_operations
              Type: STRING
            - Name: activation_override_behavior
              Type: STRING
        d16218ab-6c10-4003-8a81-b34b069e67b3:
          RelationalTable:
            DataSourceArn: ${athena_datasource_arn}
            Catalog: AwsDataCatalog
            Schema: ${athena_database_name}
            Name: account_map
            InputColumns:
            - Name: account_id
              Type: STRING
            - Name: account_name
              Type: STRING
      LogicalTableMap:
        06338664-ffcb-4fd1-855d-2127ac84c2e7:
          Alias: Intermediate Table
          Source:
            JoinInstruction:
              LeftOperand: 4f337cdb-d675-4e91-8427-4dce84259a54
              RightOperand: 35faf219-45ae-4689-a98d-d34ad579dbf5
              Type: LEFT
              OnClause: '{grantee_account_id} = {account_id}'
        35faf219-45ae-4689-a98d-d34ad579dbf5:
          Alias: account_map
          DataTransforms:
          - RenameColumnOperation:
              ColumnName: account_name
              NewColumnName: grantee_account_name
          Source:
            PhysicalTableId: d16218ab-6c10-4003-8a81-b34b069e67b3
        4526a4cc-5d48-4da0-bec4-e476cdcd0721:
          Alias: Intermediate Table (2)
          DataTransforms:
          - ProjectOperation:
              ProjectedColumns:
              - management_account_id
              - subscribed_account_id
              - grantee_account_id
              - license_create_time
              - license_start_date
              - license_end_date
              - license_id
              - productname
              - seller
              - agreement_id
              - license_status
              - productsku
              - license_issuer
              - homeregion
              - license_version
              - grant_name
              - grant_id
              - grant_status
              - grant_version
              - granted_operations
              - activation_override_behavior
              - account_id
              - grantee_account_name
              - account_id[account_map (2)]
              - subscribed_account_name
          Source:
            JoinInstruction:
              LeftOperand: 06338664-ffcb-4fd1-855d-2127ac84c2e7
              RightOperand: f072c6f3-34bf-4cbb-a446-e4711c93e782
              Type: LEFT
              OnClause: '{subscribed_account_id} = {account_id[account_map (2)]}'
        4f337cdb-d675-4e91-8427-4dce84259a54:
          Alias: marketplace_licenses_grants_view
          Source:
            PhysicalTableId: 623cef5c-7541-4cb2-9474-53cb0e222d67
        f072c6f3-34bf-4cbb-a446-e4711c93e782:
          Alias: account_map (2)
          DataTransforms:
          - RenameColumnOperation:
              ColumnName: account_id
              NewColumnName: account_id[account_map (2)]
          - RenameColumnOperation:
              ColumnName: account_name
              NewColumnName: subscribed_account_name
          Source:
            PhysicalTableId: 1ecbb2ac-1ceb-4653-ab08-dc11fdfeb1b1
      ImportMode: DIRECT_QUERY
    dependsOn:
      views:
      - account_map
      - marketplace_licenses_grants_view
      - account_map
    schedules:
    - default
crawlers: {}
views:
  marketplace_licenses_grants_view:
    data: |-
      CREATE OR REPLACE VIEW ${athena_database_name}.marketplace_licenses_grants_view AS
      SELECT DISTINCT
        lt.payer_id management_account_id
      , SPLIT_PART(lt.beneficiary, ':', 5) "subscribed_account_id"
      , SPLIT_PART(gt.granteeprincipalarn, ':', 5) "grantee_account_id"
      , FROM_UNIXTIME(CAST(lt.createtime AS DOUBLE)) "license_create_time"
      , date_parse(substr(lt.validity.begin, 1, 10), '%Y-%m-%d') "license_start_date"
      , date_parse(substr(lt.validity."end", 1, 10), '%Y-%m-%d') "license_end_date"
      , SPLIT_PART(lt.licensearn, ':', 7) "license_id"
      , lt.productname
      , data.value "seller"
      , SPLIT_PART(agreement.value, ':', 7) "agreement_id"
      , lt.status "license_status"
      , lt.productsku
      , lt.issuer.NAME "license_issuer"
      , lt.homeregion
      , lt."version" "license_version"
      , gt.grantname "grant_name"
      , SPLIT_PART(gt.grantarn, ':', 7) "grant_id"
      , gt.grantstatus "grant_status"
      , gt.version "grant_version"
      , ARRAY_JOIN(gt.grantedoperations, ',') "granted_operations"
      , gt.options.activationoverridebehavior "activation_override_behavior"
      FROM
        optimization_data.license_manager_licenses lt
      , optimization_data.license_manager_grants gt
      , UNNEST(licensemetadata) t ("data")
      , UNNEST(licensemetadata) s (agreement)
      WHERE ((lt.licensearn = gt.licensearn) AND (t."data".NAME = 'sellerOfRecord'))
