Mappings:
  Definitions:
    taoSourceAccountId:
      Value: "223485597511"
    taoSourceTemplateId:
      Value: "ta-organizational-view"
    taoDashboardId:
      Value: "ta-organizational-view"
    taoDataSourceId:
      Value: "ta-organizational-view"
    taoDataSetId:
      Value: "ta-organizational-view"
    taoAthenaTable:
      Value: "ta_organizational_view_reports"

Parameters:
  Readme1st:
    Type: String
    Default: https://wellarchitectedlabs.com/cost/200_labs/200_cloud_intelligence/trusted-advisor-dashboards/dashboards/1_prerequistes
  DatabaseName:
    Type: String
    Default: default
  S3FolderPath:
    Type: String
    Default: s3://...
  QuickSightRefreshSchedule:
    Type: String
    Default: cron(0 4 * * ? *)
    Description: CRON expression on when to refresh the QuickSight Spice Dataset. Default is 4 AM UTC, this should work for most customers in US and EU time zones. Leave empty if no refresh is needed.
  QuickSightUser:
    Type: String
    MinLength: 1
    Default: REPLACE WITH QuickSight USER
    Description: Username of QuickSight User from default namespace (as displayed in QuickSight admin panel). Dashboard created by this template with be shared with this user.
  QuicksightIdentityRegion:
    Type: String
    MinLength: 8
    Description: Can be different than the region you deploy the dashboard, typically us-east-1
    Default: us-east-1
  taoSuffix:
    Type: String
    Description: Use if you need to create multiple instances on the same AWS Account.

Conditions:
  CreateSPICERefresh: !Not [!Equals [!Ref QuickSightRefreshSchedule, ""]]

Metadata: 
  AWS::CloudFormation::Interface: 
    ParameterGroups: 
      - 
        Label: 
          default: "Information"
        Parameters: 
          - Readme1st
      - 
        Label: 
          default: "Required Parameters"
        Parameters: 
          - S3FolderPath
          - DatabaseName
          - QuickSightUser
          - QuicksightIdentityRegion
      - 
        Label: 
          default: "Optional Parameters"
        Parameters: 
          - QuickSightRefreshSchedule
          - taoSuffix
    ParameterLabels: 
      Readme1st: 
        default: "Please make sure you have covered the following prerequisites:"
      DatabaseName:
        default: "Athena Database Name:"
      S3FolderPath:
        default: "S3 Bucket Path to the TA Reports:"
      QuickSightRefreshSchedule:
        default: "Preferred Refresh Schedule:"
      QuickSightUser:
        default: "QuickSight Username:"
      QuicksightIdentityRegion:
        default: "Quicksight Identity Region:"
      taoSuffix:
        default: "Suffix value:"

Resources:
  taoGlueTable:
    Type: "AWS::Glue::Table"
    Properties:
      DatabaseName: !Ref DatabaseName
      CatalogId: !Ref "AWS::AccountId"
      TableInput:
        Name: !FindInMap [ "Definitions", "taoAthenaTable", "Value" ]
        StorageDescriptor:
          Location: !Ref S3FolderPath
          Columns:
          - Name: ip address
            Type: string
          - Name: checkname
            Type: string
          - Name: accountparentname
            Type: string
          - Name: accountid
            Type: string
          - Name: category
            Type: string
          - Name: checkid
            Type: string
          - Name: issuppressed
            Type: string
          - Name: resourceid
            Type: string
          - Name: region
            Type: string
          - Name: accountparentid
            Type: string
          - Name: timestamp
            Type: string
          - Name: accountname
            Type: string
          - Name: status
            Type: string
          - Name: acl allows list
            Type: string
          - Name: bucket name
            Type: string
          - Name: acl allows upload/delete
            Type: string
          - Name: region name
            Type: string
          - Name: policy allows access
            Type: string
          - Name: ignored bucket name
            Type: string
          - Name: region api parameter
            Type: string
          - Name: password policy
            Type: string
          - Name: reason
            Type: string
          - Name: number
            Type: string
          - Name: uppercase
            Type: string
          - Name: lowercase
            Type: string
          - Name: non-alphanumeric
            Type: string
          - Name: write enabled
            Type: string
          - Name: same owner
            Type: string
          - Name: target exists
            Type: string
          - Name: target name
            Type: string
          - Name: trail name
            Type: string
          - Name: logging status
            Type: string
          - Name: last delivery error
            Type: string
          - Name: access key
            Type: string
          - Name: key last rotated
            Type: string
          - Name: iam user
            Type: string
          - Name: mfa delete enabled
            Type: string
          - Name: versioning
            Type: string
          - Name: current usage
            Type: string
          - Name: service
            Type: string
          - Name: limit amount
            Type: string
          - Name: limit name
            Type: string
          - Name: snapshot id
            Type: string
          - Name: volume name
            Type: string
          - Name: snapshot age
            Type: string
          - Name: volume attachment
            Type: string
          - Name: volume id
            Type: string
          - Name: snapshot name
            Type: string
          - Name: volume type
            Type: string
          - Name: volume size
            Type: string
          - Name: monthly storage cost
            Type: string
          - Name: max daily median
            Type: string
          - Name: number of days over
            Type: string
          - Name: day 14
            Type: string
          - Name: day 13
            Type: string
          - Name: day 12
            Type: string
          - Name: day 11
            Type: string
          - Name: day 10
            Type: string
          - Name: day 1
            Type: string
          - Name: day 2
            Type: string
          - Name: day 3
            Type: string
          - Name: day 8
            Type: string
          - Name: day 9
            Type: string
          - Name: day 4
            Type: string
          - Name: day 5
            Type: string
          - Name: day 6
            Type: string
          - Name: day 7
            Type: string
          - Name: region/az
            Type: string
          - Name: 14-day average cpu utilization
            Type: string
          - Name: instance type
            Type: string
          - Name: instance name
            Type: string
          - Name: estimated monthly savings
            Type: string
          - Name: 14-day average network i/o
            Type: string
          - Name: number of days low utilization
            Type: string
          - Name: instance id
            Type: string
          - Name: instances in zone a
            Type: string
          - Name: instances in zone b
            Type: string
          - Name: instances in zone e
            Type: string
          - Name: instances in zone f
            Type: string
          - Name: instances in zone c
            Type: string
          - Name: instances in zone d
            Type: string
          - Name: load balancer associated
            Type: string
          - Name: auto scaling group name
            Type: string
          - Name: health check
            Type: string
          - Name: total inbound rules
            Type: string
          - Name: total outbound rules
            Type: string
          - Name: vpc id
            Type: string
          - Name: db instance
            Type: string
          - Name: multi-az
            Type: string
          - Name: security group id
            Type: string
          - Name: ports
            Type: string
          - Name: security group name
            Type: string
          - Name: protocol
            Type: string
          - Name: port
            Type: string
          - Name: ip range
            Type: string
          - Name: customer gateway
            Type: string
          - Name: vpc
            Type: string
          - Name: active tunnels
            Type: string
          - Name: vpn id
            Type: string
          - Name: virtual private gateway
            Type: string
          - Name: distribution domain name
            Type: string
          - Name: distribution id
            Type: string
          - Name: alternate domain name
            Type: string
          - Name: hosted zone name
            Type: string
          - Name: hosted zone id
            Type: string
          - Name: number of name server delegations used
            Type: string
          - Name: number of days over 90% cpu utilization
            Type: string
          - Name: resource name
            Type: string
          - Name: launch configuration name
            Type: string
          - Name: launch type
            Type: string
          - Name: resource type
            Type: string
          - Name: launch name
            Type: string
          - Name: backup retention period
            Type: string
          - Name: description
            Type: string
          - Name: instance count
            Type: string
          - Name: group id
            Type: string
          - Name: resource record set identifier
            Type: string
          - Name: resource record set type
            Type: string
          - Name: alias target
            Type: string
          - Name: resource record set name
            Type: string
          - Name: headers
            Type: string
          - Name: cache behavior path pattern
            Type: string
          - Name: lookback period (days)
            Type: string
          - Name: upfront cost
            Type: string
          - Name: payment option
            Type: string
          - Name: hourly commitment to purchase
            Type: string
          - Name: estimated savings percentage
            Type: string
          - Name: term (years)
            Type: string
          - Name: savings plan type
            Type: string
          - Name: estimated average utilization
            Type: string
          - Name: origin
            Type: string
          - Name: days since last connection
            Type: string
          - Name: db instance name
            Type: string
          - Name: storage provisioned (gb)
            Type: string
          - Name: estimated monthly savings (on demand)
            Type: string
          - Name: cluster
            Type: string
          - Name: estimated break even (months)
            Type: string
          - Name: platform
            Type: string
          - Name: expected average ri utilization
            Type: string
          - Name: estimated on-demand cost post recommended ri purchase (monthly)
            Type: string
          - Name: recommended number of ris to purchase
            Type: string
          - Name: upfront cost of ris
            Type: string
          - Name: estimated savings with recommendation (monthly)
            Type: string
          - Name: estimated cost of ris (monthly)
            Type: string
          - Name: load balancer name
            Type: string
          - Name: "# of zones"
            Type: string
          - Name: access key id
            Type: string
          - Name: case id
            Type: string
          - Name: certificate name
            Type: string
          - Name: connection details
            Type: string
          - Name: connection id for vif
            Type: string
          - Name: connection id
            Type: string
          - Name: current monthly cost
            Type: string
          - Name: data transfer out (gb)
            Type: string
          - Name: database edition
            Type: string
          - Name: database engine
            Type: string
          - Name: db instance or cluster id
            Type: string
          - Name: deadline
            Type: string
          - Name: deployment option
            Type: string
          - Name: ebs optimized
            Type: string
          - Name: estimated cost of reserved instances (monthly)
            Type: string
          - Name: estimated cost of reserved nodes (monthly)
            Type: string
          - Name: estimated on-demand cost post recommended reserved instance purchase (monthly)
            Type: string
          - Name: estimated on-demand cost post recommended reserved nodes purchase (monthly)
            Type: string
          - Name: expected average reserved instance utilization
            Type: string
          - Name: expected average reserved node utilization
            Type: string
          - Name: expected avergae reserved instance utilization
            Type: string
          - Name: expected avergae reserved node utilization
            Type: string
          - Name: expiration date
            Type: string
          - Name: family
            Type: string
          - Name: fraud type
            Type: string
          - Name: gateway id
            Type: string
          - Name: ingress rule
            Type: string
          - Name: instance class
            Type: string
          - Name: instance size
            Type: string
          - Name: license model
            Type: string
          - Name: load balancer port
            Type: string
          - Name: location for vif
            Type: string
          - Name: location
            Type: string
          - Name: node type
            Type: string
          - Name: private db instances
            Type: string
          - Name: product description
            Type: string
          - Name: public db instances
            Type: string
          - Name: ratio of transfer to storage
            Type: string
          - Name: rds security group name
            Type: string
          - Name: recommended number of reserved instances to purchase
            Type: string
          - Name: recommended number of reserved nodes to purchase
            Type: string
          - Name: reserved instance id
            Type: string
          - Name: resource record set id
            Type: string
          - Name: s3 storage (gb)
            Type: string
          - Name: security group ids
            Type: string
          - Name: time near maximum
            Type: string
          - Name: time updated
            Type: string
          - Name: ttl
            Type: string
          - Name: upfront cost of reserved instances
            Type: string
          - Name: upfront cost of reserved nodes
            Type: string
          - Name: usage (usd per day)
            Type: string
          - Name: user name (iam or root)
            Type: string
          - Name: zone
            Type: string
          - Name: function arn
            Type: string
          - Name: max daily error rate
            Type: string
          - Name: date for max error rate
            Type: string
          - Name: average daily error rate
            Type: string
          - Name: lost daily compute cost
            Type: string
          - Name: current day invokes
            Type: string
          - Name: current day error rate
            Type: string
          - Name: average daily invokes
            Type: string
          - Name: last refresh time
            Type: string
          - Name: max daily timeout rate
            Type: string
          - Name: date of max daily timeout rate
            Type: string
          - Name: average daily timeout rate
            Type: string
          - Name: function timeout setting
            Type: string
          - Name: current day timeout rate
            Type: string
          - Name: runtime
            Type: string
          - Name: days to deprecation
            Type: string
          - Name: deprecation date
            Type: string
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
            Parameters:
              paths: 14-Day Average CPU Utilization,14-Day Average Network I/O,ACL Allows List,ACL Allows Upload/Delete,Access Key,AccountId,AccountName,AccountParentId,AccountParentName,Active Tunnels,Alias Target,Alternate Domain Name,Auto Scaling Group Name,Backup Retention Period,Bucket Name,Cache Behavior Path Pattern,Category,CheckId,CheckName,Cluster,Current Usage,Customer Gateway,DB Instance,DB Instance Name,Day 1,Day 10,Day 11,Day 12,Day 13,Day 14,Day 2,Day 3,Day 4,Day 5,Day 6,Day 7,Day 8,Day 9,Days Since Last Connection,Description,Distribution Domain Name,Distribution ID,Estimated Break Even (Months),Estimated Monthly Savings,Estimated Monthly Savings (On Demand),Estimated On-Demand Cost Post Recommended RI Purchase (Monthly),Estimated Savings with Recommendation (Monthly),Estimated average utilization,Estimated cost of RIs (Monthly),Estimated savings percentage,Expected Average RI Utilization,Group ID,Headers,Health Check,Hosted Zone ID,Hosted Zone Name,Hourly commitment to purchase,IAM User,IP Address,IP Range,Ignored Bucket Name,Instance Count,Instance ID,Instance Name,Instance Type,Instances in Zone a,Instances in Zone b,Instances in Zone c,Instances in Zone d,Instances in Zone e,Instances in Zone f,Key Last Rotated,Last Delivery Error,Launch Configuration Name,Launch Name,Launch Type,Limit Amount,Limit Name,Load Balancer Associated,Load Balancer Name,Logging Status,Lookback Period (Days),Lowercase,MFA Delete Enabled,Max Daily Median,Monthly Storage Cost,Multi-AZ,Non-alphanumeric,Number,Number of Days Low Utilization,Number of Days Over,Number of Days over 90% CPU Utilization,Number of Name Server Delegations Used,Origin,Password Policy,Payment option,Platform,Policy Allows Access,Port,Ports,Protocol,Reason,Recommended Number of RIs to Purchase,Region,Region API Parameter,Region Name,Region/AZ,Resource Name,Resource Record Set Identifier,Resource Record Set Name,Resource Record Set Type,Resource Type,ResourceId,Same Owner,Savings Plan type,Security Group ID,Security Group Name,Service,Snapshot Age,Snapshot ID,Snapshot Name,Status,Storage Provisioned (GB),Target Exists,Target Name,Term (Years),Timestamp,Total Inbound Rules,Total Outbound Rules,Trail Name,Upfront Cost of RIs,Upfront cost,Uppercase,VPC,VPC ID,VPN ID,Versioning,Virtual Private Gateway,Volume Attachment,Volume ID,Volume Name,Volume Size,Volume Type,Write Enabled,isSuppressed,# of Zones,Access Key ID,Case ID,Certificate Name,Connection Details,Connection ID for VIF,Connection ID,Current Monthly Cost,Data Transfer Out (GB),Database Edition,Database Engine,DB Instance or Cluster ID,Deadline,Deployment Option,EBS Optimized,Estimated cost of Reserved Instances (monthly),Estimated cost of Reserved Nodes (monthly),Estimated On-Demand Cost Post Recommended Reserved Instance Purchase (monthly),Estimated On-Demand Cost Post Recommended Reserved Nodes Purchase (monthly),Expected Average Reserved Instance Utilization,Expected Average Reserved Node Utilization,Expected Avergae Reserved Instance Utilization,Expected Avergae Reserved Node Utilization,Expiration Date,Family,Fraud Type,Gateway ID,Ingress Rule,Instance Class,Instance Size,License Model,Load Balancer Port,Location for VIF,Location,Node Type,Private DB Instances,Product Description,Public DB Instances,Ratio of Transfer to Storage,RDS Security Group Name,Recommended number of Reserved Instances to purchase,Recommended number of Reserved Nodes to purchase,Reserved Instance ID,Resource Record Set ID,S3 Storage (GB),Security Group IDs,Time Near Maximum,Time Updated,TTL,Upfront Cost of Reserved Instances,Upfront Cost of Reserved Nodes,Usage (USD per Day),User Name (IAM or Root),Zone,Function ARN,Max daily error rate,Date for max error rate,Average daily error rate,Lost daily compute cost,Current day invokes,Current day error rate,Average daily invokes,Last refresh time,Max daily timeout rate,Date of max daily timeout rate,Average daily timeout rate,Function timeout setting,Current day timeout rate,Runtime,Days to deprecation,Deprecation date
  # ----
  taoQuickSightDataSource:
    Type: AWS::QuickSight::DataSource
    DependsOn: taoGlueTable
    Properties: 
      AwsAccountId: !Ref "AWS::AccountId"
      DataSourceId: !Join 
        - ''
        - - !FindInMap [ "Definitions", "taoDataSourceId", "Value" ]
          - !Ref taoSuffix 
      Name: !Join [ '' , [ 'ta-organizational-view' ,  !Ref taoSuffix ] ]
      Type: ATHENA
      DataSourceParameters:
        AthenaParameters:
          WorkGroup: primary
      SslProperties:
        DisableSsl: false
      Permissions:
      - Principal: !Sub
        - 'arn:aws:quicksight:${Region}:${AWS::AccountId}:user/default/${Username}'
        - Username: !Ref QuickSightUser
          Region: !Ref QuicksightIdentityRegion
        Actions:
        - quicksight:DescribeDataSource
        - quicksight:DescribeDataSourcePermissions
        - quicksight:PassDataSource
        - quicksight:UpdateDataSource
        - quicksight:DeleteDataSource
        - quicksight:UpdateDataSourcePermissions
  # ----
  taoQuickSightDataSet:
    Type: AWS::QuickSight::DataSet
    Properties:
      AwsAccountId: !Ref "AWS::AccountId"
      DataSetId: !Join 
        - ''
        - - !FindInMap [ "Definitions", "taoDataSetId", "Value" ]
          - !Ref taoSuffix 
      Name: !Join [ '' , [ 'ta-organizational-view' ,  !Ref taoSuffix ] ] 
      Permissions:
      - Principal: !Sub
        - 'arn:aws:quicksight:${Region}:${AWS::AccountId}:user/default/${Username}'
        - Username: !Ref QuickSightUser
          Region: !Ref QuicksightIdentityRegion
        Actions:
        - quicksight:UpdateDataSetPermissions
        - quicksight:DescribeDataSet
        - quicksight:DescribeDataSetPermissions
        - quicksight:PassDataSet
        - quicksight:DescribeIngestion
        - quicksight:ListIngestions
        - quicksight:UpdateDataSet
        - quicksight:DeleteDataSet
        - quicksight:CreateIngestion
        - quicksight:CancelIngestion
      PhysicalTableMap:
        b5de237f-b599-407f-87ec-32024624ba65:
          RelationalTable:
            DataSourceArn: !GetAtt taoQuickSightDataSource.Arn
            Catalog: AwsDataCatalog
            Schema: !Ref DatabaseName
            Name: ta_organizational_view_reports
            InputColumns:
            - Name: ip address
              Type: STRING
            - Name: checkname
              Type: STRING
            - Name: accountparentname
              Type: STRING
            - Name: accountid
              Type: STRING
            - Name: category
              Type: STRING
            - Name: checkid
              Type: STRING
            - Name: issuppressed
              Type: STRING
            - Name: resourceid
              Type: STRING
            - Name: region
              Type: STRING
            - Name: accountparentid
              Type: STRING
            - Name: timestamp
              Type: STRING
            - Name: accountname
              Type: STRING
            - Name: status
              Type: STRING
            - Name: acl allows list
              Type: STRING
            - Name: bucket name
              Type: STRING
            - Name: acl allows upload/delete
              Type: STRING
            - Name: region name
              Type: STRING
            - Name: policy allows access
              Type: STRING
            - Name: ignored bucket name
              Type: STRING
            - Name: region api parameter
              Type: STRING
            - Name: password policy
              Type: STRING
            - Name: reason
              Type: STRING
            - Name: number
              Type: STRING
            - Name: uppercase
              Type: STRING
            - Name: lowercase
              Type: STRING
            - Name: non-alphanumeric
              Type: STRING
            - Name: write enabled
              Type: STRING
            - Name: same owner
              Type: STRING
            - Name: target exists
              Type: STRING
            - Name: target name
              Type: STRING
            - Name: trail name
              Type: STRING
            - Name: logging status
              Type: STRING
            - Name: last delivery error
              Type: STRING
            - Name: access key
              Type: STRING
            - Name: key last rotated
              Type: STRING
            - Name: iam user
              Type: STRING
            - Name: mfa delete enabled
              Type: STRING
            - Name: versioning
              Type: STRING
            - Name: current usage
              Type: STRING
            - Name: service
              Type: STRING
            - Name: limit amount
              Type: STRING
            - Name: limit name
              Type: STRING
            - Name: snapshot id
              Type: STRING
            - Name: volume name
              Type: STRING
            - Name: snapshot age
              Type: STRING
            - Name: volume attachment
              Type: STRING
            - Name: volume id
              Type: STRING
            - Name: snapshot name
              Type: STRING
            - Name: volume type
              Type: STRING
            - Name: volume size
              Type: STRING
            - Name: monthly storage cost
              Type: STRING
            - Name: max daily median
              Type: STRING
            - Name: number of days over
              Type: STRING
            - Name: day 14
              Type: STRING
            - Name: day 13
              Type: STRING
            - Name: day 12
              Type: STRING
            - Name: day 11
              Type: STRING
            - Name: day 10
              Type: STRING
            - Name: day 1
              Type: STRING
            - Name: day 2
              Type: STRING
            - Name: day 3
              Type: STRING
            - Name: day 8
              Type: STRING
            - Name: day 9
              Type: STRING
            - Name: day 4
              Type: STRING
            - Name: day 5
              Type: STRING
            - Name: day 6
              Type: STRING
            - Name: day 7
              Type: STRING
            - Name: region/az
              Type: STRING
            - Name: 14-day average cpu utilization
              Type: STRING
            - Name: instance type
              Type: STRING
            - Name: instance name
              Type: STRING
            - Name: estimated monthly savings
              Type: STRING
            - Name: 14-day average network i/o
              Type: STRING
            - Name: number of days low utilization
              Type: STRING
            - Name: instance id
              Type: STRING
            - Name: instances in zone a
              Type: STRING
            - Name: instances in zone b
              Type: STRING
            - Name: instances in zone e
              Type: STRING
            - Name: instances in zone f
              Type: STRING
            - Name: instances in zone c
              Type: STRING
            - Name: instances in zone d
              Type: STRING
            - Name: load balancer associated
              Type: STRING
            - Name: auto scaling group name
              Type: STRING
            - Name: health check
              Type: STRING
            - Name: total inbound rules
              Type: STRING
            - Name: total outbound rules
              Type: STRING
            - Name: vpc id
              Type: STRING
            - Name: db instance
              Type: STRING
            - Name: multi-az
              Type: STRING
            - Name: security group id
              Type: STRING
            - Name: ports
              Type: STRING
            - Name: security group name
              Type: STRING
            - Name: protocol
              Type: STRING
            - Name: port
              Type: STRING
            - Name: ip range
              Type: STRING
            - Name: customer gateway
              Type: STRING
            - Name: vpc
              Type: STRING
            - Name: active tunnels
              Type: STRING
            - Name: vpn id
              Type: STRING
            - Name: virtual private gateway
              Type: STRING
            - Name: distribution domain name
              Type: STRING
            - Name: distribution id
              Type: STRING
            - Name: alternate domain name
              Type: STRING
            - Name: hosted zone name
              Type: STRING
            - Name: hosted zone id
              Type: STRING
            - Name: number of name server delegations used
              Type: STRING
            - Name: number of days over 90% cpu utilization
              Type: STRING
            - Name: resource name
              Type: STRING
            - Name: launch configuration name
              Type: STRING
            - Name: launch type
              Type: STRING
            - Name: resource type
              Type: STRING
            - Name: launch name
              Type: STRING
            - Name: backup retention period
              Type: STRING
            - Name: description
              Type: STRING
            - Name: instance count
              Type: STRING
            - Name: group id
              Type: STRING
            - Name: resource record set identifier
              Type: STRING
            - Name: resource record set type
              Type: STRING
            - Name: alias target
              Type: STRING
            - Name: resource record set name
              Type: STRING
            - Name: headers
              Type: STRING
            - Name: cache behavior path pattern
              Type: STRING
            - Name: lookback period (days)
              Type: STRING
            - Name: upfront cost
              Type: STRING
            - Name: payment option
              Type: STRING
            - Name: hourly commitment to purchase
              Type: STRING
            - Name: estimated savings percentage
              Type: STRING
            - Name: term (years)
              Type: STRING
            - Name: savings plan type
              Type: STRING
            - Name: estimated average utilization
              Type: STRING
            - Name: origin
              Type: STRING
            - Name: days since last connection
              Type: STRING
            - Name: db instance name
              Type: STRING
            - Name: storage provisioned (gb)
              Type: STRING
            - Name: estimated monthly savings (on demand)
              Type: STRING
            - Name: cluster
              Type: STRING
            - Name: estimated break even (months)
              Type: STRING
            - Name: platform
              Type: STRING
            - Name: expected average ri utilization
              Type: STRING
            - Name: estimated on-demand cost post recommended ri purchase (monthly)
              Type: STRING
            - Name: recommended number of ris to purchase
              Type: STRING
            - Name: upfront cost of ris
              Type: STRING
            - Name: estimated savings with recommendation (monthly)
              Type: STRING
            - Name: estimated cost of ris (monthly)
              Type: STRING
            - Name: load balancer name
              Type: STRING
            - Name: "# of zones"
              Type: STRING
            - Name: access key id
              Type: STRING
            - Name: case id
              Type: STRING
            - Name: certificate name
              Type: STRING
            - Name: connection details
              Type: STRING
            - Name: connection id for vif
              Type: STRING
            - Name: connection id
              Type: STRING
            - Name: current monthly cost
              Type: STRING
            - Name: data transfer out (gb)
              Type: STRING
            - Name: database edition
              Type: STRING
            - Name: database engine
              Type: STRING
            - Name: db instance or cluster id
              Type: STRING
            - Name: deadline
              Type: STRING
            - Name: deployment option
              Type: STRING
            - Name: ebs optimized
              Type: STRING
            - Name: estimated cost of reserved instances (monthly)
              Type: STRING
            - Name: estimated cost of reserved nodes (monthly)
              Type: STRING
            - Name: estimated on-demand cost post recommended reserved instance purchase
                (monthly)
              Type: STRING
            - Name: estimated on-demand cost post recommended reserved nodes purchase (monthly)
              Type: STRING
            - Name: expected average reserved instance utilization
              Type: STRING
            - Name: expected average reserved node utilization
              Type: STRING
            - Name: expected avergae reserved instance utilization
              Type: STRING
            - Name: expected avergae reserved node utilization
              Type: STRING
            - Name: expiration date
              Type: STRING
            - Name: family
              Type: STRING
            - Name: fraud type
              Type: STRING
            - Name: gateway id
              Type: STRING
            - Name: ingress rule
              Type: STRING
            - Name: instance class
              Type: STRING
            - Name: instance size
              Type: STRING
            - Name: license model
              Type: STRING
            - Name: load balancer port
              Type: STRING
            - Name: location for vif
              Type: STRING
            - Name: location
              Type: STRING
            - Name: node type
              Type: STRING
            - Name: private db instances
              Type: STRING
            - Name: product description
              Type: STRING
            - Name: public db instances
              Type: STRING
            - Name: ratio of transfer to storage
              Type: STRING
            - Name: rds security group name
              Type: STRING
            - Name: recommended number of reserved instances to purchase
              Type: STRING
            - Name: recommended number of reserved nodes to purchase
              Type: STRING
            - Name: reserved instance id
              Type: STRING
            - Name: resource record set id
              Type: STRING
            - Name: s3 storage (gb)
              Type: STRING
            - Name: security group ids
              Type: STRING
            - Name: time near maximum
              Type: STRING
            - Name: time updated
              Type: STRING
            - Name: ttl
              Type: STRING
            - Name: upfront cost of reserved instances
              Type: STRING
            - Name: upfront cost of reserved nodes
              Type: STRING
            - Name: usage (usd per day)
              Type: STRING
            - Name: user name (iam or root)
              Type: STRING
            - Name: zone
              Type: STRING
            - Name: function arn
              Type: STRING
            - Name: max daily error rate
              Type: STRING
            - Name: date for max error rate
              Type: STRING
            - Name: average daily error rate
              Type: STRING
            - Name: lost daily compute cost
              Type: STRING
            - Name: current day invokes
              Type: STRING
            - Name: current day error rate
              Type: STRING
            - Name: average daily invokes
              Type: STRING
            - Name: last refresh time
              Type: STRING
            - Name: max daily timeout rate
              Type: STRING
            - Name: date of max daily timeout rate
              Type: STRING
            - Name: average daily timeout rate
              Type: STRING
            - Name: function timeout setting
              Type: STRING
            - Name: current day timeout rate
              Type: STRING
            - Name: runtime
              Type: STRING
            - Name: days to deprecation
              Type: STRING
            - Name: deprecation date
              Type: STRING
      LogicalTableMap:
        b5de237f-b599-407f-87ec-32024624ba65:
          Alias: ta_organizational_view_reports
          DataTransforms:
          - TagColumnOperation:
              ColumnName: region
              Tags:
              - ColumnGeographicRole: STATE
          - TagColumnOperation:
              ColumnName: region name
              Tags:
              - ColumnGeographicRole: STATE
          - TagColumnOperation:
              ColumnName: region api parameter
              Tags:
              - ColumnGeographicRole: STATE
          - ProjectOperation:
              ProjectedColumns:
              - ip address
              - checkname
              - accountparentname
              - accountid
              - category
              - checkid
              - issuppressed
              - resourceid
              - region
              - accountparentid
              - timestamp
              - accountname
              - status
              - acl allows list
              - bucket name
              - acl allows upload/delete
              - region name
              - policy allows access
              - ignored bucket name
              - region api parameter
              - password policy
              - reason
              - number
              - uppercase
              - lowercase
              - non-alphanumeric
              - write enabled
              - same owner
              - target exists
              - target name
              - trail name
              - logging status
              - last delivery error
              - access key
              - key last rotated
              - iam user
              - mfa delete enabled
              - versioning
              - current usage
              - service
              - limit amount
              - limit name
              - snapshot id
              - volume name
              - snapshot age
              - volume attachment
              - volume id
              - snapshot name
              - volume type
              - volume size
              - monthly storage cost
              - max daily median
              - number of days over
              - day 14
              - day 13
              - day 12
              - day 11
              - day 10
              - day 1
              - day 2
              - day 3
              - day 8
              - day 9
              - day 4
              - day 5
              - day 6
              - day 7
              - region/az
              - 14-day average cpu utilization
              - instance type
              - instance name
              - estimated monthly savings
              - 14-day average network i/o
              - number of days low utilization
              - instance id
              - instances in zone a
              - instances in zone b
              - instances in zone e
              - instances in zone f
              - instances in zone c
              - instances in zone d
              - load balancer associated
              - auto scaling group name
              - health check
              - total inbound rules
              - total outbound rules
              - vpc id
              - db instance
              - multi-az
              - security group id
              - ports
              - security group name
              - protocol
              - port
              - ip range
              - customer gateway
              - vpc
              - active tunnels
              - vpn id
              - virtual private gateway
              - distribution domain name
              - distribution id
              - alternate domain name
              - hosted zone name
              - hosted zone id
              - number of name server delegations used
              - number of days over 90% cpu utilization
              - resource name
              - launch configuration name
              - launch type
              - resource type
              - launch name
              - backup retention period
              - description
              - instance count
              - group id
              - resource record set identifier
              - resource record set type
              - alias target
              - resource record set name
              - headers
              - cache behavior path pattern
              - lookback period (days)
              - upfront cost
              - payment option
              - hourly commitment to purchase
              - estimated savings percentage
              - term (years)
              - savings plan type
              - estimated average utilization
              - origin
              - days since last connection
              - db instance name
              - storage provisioned (gb)
              - estimated monthly savings (on demand)
              - cluster
              - estimated break even (months)
              - platform
              - expected average ri utilization
              - estimated on-demand cost post recommended ri purchase (monthly)
              - recommended number of ris to purchase
              - upfront cost of ris
              - estimated savings with recommendation (monthly)
              - estimated cost of ris (monthly)
              - load balancer name
              - "# of zones"
              - access key id
              - case id
              - certificate name
              - connection details
              - connection id for vif
              - connection id
              - current monthly cost
              - data transfer out (gb)
              - database edition
              - database engine
              - db instance or cluster id
              - deadline
              - deployment option
              - ebs optimized
              - estimated cost of reserved instances (monthly)
              - estimated cost of reserved nodes (monthly)
              - estimated on-demand cost post recommended reserved instance purchase (monthly)
              - estimated on-demand cost post recommended reserved nodes purchase (monthly)
              - expected average reserved instance utilization
              - expected average reserved node utilization
              - expected avergae reserved instance utilization
              - expected avergae reserved node utilization
              - expiration date
              - family
              - fraud type
              - gateway id
              - ingress rule
              - instance class
              - instance size
              - license model
              - load balancer port
              - location for vif
              - location
              - node type
              - private db instances
              - product description
              - public db instances
              - ratio of transfer to storage
              - rds security group name
              - recommended number of reserved instances to purchase
              - recommended number of reserved nodes to purchase
              - reserved instance id
              - resource record set id
              - s3 storage (gb)
              - security group ids
              - time near maximum
              - time updated
              - ttl
              - upfront cost of reserved instances
              - upfront cost of reserved nodes
              - usage (usd per day)
              - user name (iam or root)
              - zone
              - function arn
              - max daily error rate
              - date for max error rate
              - average daily error rate
              - lost daily compute cost
              - current day invokes
              - current day error rate
              - average daily invokes
              - last refresh time
              - max daily timeout rate
              - date of max daily timeout rate
              - average daily timeout rate
              - function timeout setting
              - current day timeout rate
              - runtime
              - days to deprecation
              - deprecation date
          Source:
            PhysicalTableId: b5de237f-b599-407f-87ec-32024624ba65
      ImportMode: SPICE
  # ----
  taoQuickSightDashboard:
    Type: AWS::QuickSight::Dashboard
    Properties:
      AwsAccountId: !Ref "AWS::AccountId"
      DashboardId: !Join 
        - ''
        - - !FindInMap [ "Definitions", "taoDashboardId", "Value" ]
          - !Ref taoSuffix 
      Name: !Join [ '' , [ 'Trusted Advisor Organizational View' ,  !Ref taoSuffix ] ]
      Permissions:
      - Principal: !Sub
        - 'arn:aws:quicksight:${Region}:${AWS::AccountId}:user/default/${Username}'
        - Username: !Ref QuickSightUser
          Region: !Ref QuicksightIdentityRegion
        Actions:
        - quicksight:DescribeDashboard
        - quicksight:ListDashboardVersions
        - quicksight:UpdateDashboardPermissions
        - quicksight:QueryDashboard
        - quicksight:UpdateDashboard
        - quicksight:DeleteDashboard
        - quicksight:DescribeDashboardPermissions
        - quicksight:UpdateDashboardPublishedVersion
      DashboardPublishOptions:
        AdHocFilteringOption:
          AvailabilityStatus: DISABLED
      SourceEntity:
        SourceTemplate:
          DataSetReferences:
          - DataSetPlaceholder: ta-organizational-view
            DataSetArn: !GetAtt taoQuickSightDataSet.Arn
          Arn: !Join 
            - ''
            - - 'arn:aws:quicksight:us-east-1:'
              - !FindInMap [ "Definitions", "taoSourceAccountId", "Value" ]
              - ':template/'
              - !FindInMap [ "Definitions", "taoSourceTemplateId", "Value" ]
      VersionDescription: '1'
  # ----
  taoSpiceRefreshExecutionRole:
    Type: AWS::IAM::Role
    Condition: CreateSPICERefresh
    Properties:
      Path: /
      RoleName: !Join
        - ''
        - - taoSpiceRefreshExecutionRole
          - !Ref taoSuffix
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: !Join
          - ''
          - - SpiceRefreshExecutionPolicy
            - !Ref taoSuffix
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - quicksight:CreateIngestion
                Resource:
                  - Fn::Join: [ "/", [!GetAtt taoQuickSightDataSet.Arn , "ingestion", "*" ] ]
              - Effect: Allow
                Action:
                  - quicksight:ListDatasets
                Resource:
                  - !Sub arn:aws:quicksight:${AWS::Region}:${AWS::AccountId}:dataset/*
  # ----
  taoSpiceRefreshLambdaCreator:
    Type: AWS::Lambda::Function
    Condition: CreateSPICERefresh
    Properties:
      Runtime: python3.7
      FunctionName: !Join
        - ''
        - - taoQuickSightRefreshDatasets
          - !Ref taoSuffix
      Handler: index.lambda_handler
      MemorySize: 128
      Role: !GetAtt taoSpiceRefreshExecutionRole.Arn
      Timeout: 60
      Environment:
        Variables:
          suffix: !Ref taoSuffix
      Code:
        ZipFile: |
          import boto3
          from datetime import datetime
          import os
          
          DATASETS_TO_REFRESH = [
              "ta-organizational-view" + os.environ['suffix']
          ]

          def get_account_id():
              sts = boto3.client('sts')
              account_id = sts.get_caller_identity()['Account']
              print('account_id = ', account_id)
              return account_id
          
          def refresh_datasets(account_id):
              quicksight = boto3.client('quicksight')
              datasets = quicksight.list_data_sets(AwsAccountId=account_id)
              for dataset in datasets['DataSetSummaries']:
                  name = dataset['Name']
                  if dataset['ImportMode'] == 'SPICE' and name in DATASETS_TO_REFRESH:               
                      ingestion_id = datetime.now().strftime("%d%m%y-%H%M%S-%f")
                      print("Refreshing dataset {0}".format(name))
                      res = quicksight.create_ingestion(
                          AwsAccountId=account_id,
                          DataSetId=dataset['DataSetId'],
                          IngestionId=ingestion_id
                        )
                      print(res)

          def lambda_handler(event, context):
              account_id = get_account_id()
              refresh_datasets(account_id)
  # ----
  taoSpiceRefreshRule:
    Type: AWS::Events::Rule
    Condition: CreateSPICERefresh
    Properties:
      ScheduleExpression: !Ref QuickSightRefreshSchedule
      Targets:
        - Id: SpiceRefreshScheduler
          Arn: !GetAtt taoSpiceRefreshLambdaCreator.Arn
  # ----
  taoInvokeLambdaPermission:
    Type: AWS::Lambda::Permission
    Condition: CreateSPICERefresh
    Properties:
      FunctionName: !GetAtt taoSpiceRefreshLambdaCreator.Arn
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt taoSpiceRefreshRule.Arn